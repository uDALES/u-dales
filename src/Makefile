# ------------------------ Set variables ------------------------------
# Executable name
TARGET=dales3

# Set platform to compile for [ HUYGENS | ASTER | LOCAL ]
PLATFORM=$(SYST)
DEBUG=FALSE
# Set NetCDF module
DONETCDF=TRUE

# Objects required for build
FSRC=$(wildcard *.f90)
FOBJS=$(FSRC:.f90=.o)

# required libraries and locations

ifeq ($(PLATFORM), HUYGENS)
  FC          =  mpfort
  FCOPTS     += -qsmallstack=dynlenonheap -qfree=F90 -qrealsize=8 -qwarn64 -qflttrap=en:ov:zero:inv:imp -qflag=w:e
  FLOPTS     += -qsmallstack=dynlenonheap -qrealsize=8 -qwarn64 -qflttrap=en:ov:zero:inv:imp -qflag=w:e
  NETCDF_INCDIR=$(SARA_NETCDF_INCLUDE)
  NETCDF_LIBDIR=$(SARA_NETCDF_LIB)
  NETCDF_LIBS = netcdff netcdf
  ifeq ($(DEBUG),TRUE)
    FCOPTS     += -O2 -g -qfullpath -C -qsigtrap -qinitauto=ff
    FLOPTS     += -O2 -g -qfullpath -C -qsigtrap -qinitauto=ff
  else
    FCOPTS     += -O5 -qnoipa
    FLOPTS     += -O5 -qnoipa
  endif
endif

# settings for local WS Run using MPI on intel
ifeq ($(PLATFORM), localpc_ifort)
  FC          =  mpif90
  FCOPTS     += -r8 -ftz -fpe0 -extend_source -O3
  FLOPTS     += -ftz -fpe0 -O3
  NETCDF_INCDIR=
  NETCDF_LIBDIR=
  ifeq ($(DEBUG),TRUE)
    FCOPTS     += -O0 -g -inline_debug_info -traceback
    FLOPTS     += -O0 -g -inline_debug_info -traceback
  endif
endif

# settings for local WS Run using MPI on gfortran
ifeq ($(PLATFORM), localpc_gfortran)
  FC          = mpif90
  FCOPTS      = -W -Wall -fdefault-real-8 -ffree-line-length-none
  INCDIRS =
  LIBDIRS =
  NETCDF_LIBS = netcdff netcdf
  NETCDF_INCDIR =/usr/include
  NETCDF_LIBDIR =/usr/lib
  ifeq ($(DEBUG),TRUE)
    FCOPTS     += -O0 -g -ffpe-trap=invalid,zero,overflow
    FLOPTS     += -O0 -g -ffpe-trap=invalid,zero,overflow
  else
    FCOPTS     += -O3
    FLOPTS     += -O3
  endif
endif


LIBS       += $(MPI_LIB)
INCDIRS    += $(MPI_INCDIR)
LIBDIRS    += $(MPI_LIBDIR)

# ---- Add NetCDF INC and LIB

ifeq ($(DONETCDF), TRUE)
  LIBS       += $(NETCDF_LIBS)
  INCDIRS    += $(NETCDF_INCDIR)
  LIBDIRS    += $(NETCDF_LIBDIR)
endif


# ----------------------------------------------------------------------

# Some compiler and linker options
FCINCOPTS     =  $(patsubst %, -I%, $(INCDIRS))

FL            = $(FC)
FLOPTS       +=
FLLIBOPTS     = $(patsubst %, -L%, $(LIBDIRS)) $(patsubst %, -l%, $(LIBS))

VPATH = $(subst ,:,$(INCDIRS))

# ---------------------   Build rules -----------------------------------
.PHONY:  all
all: depend $(TARGET)

$(TARGET): $(FOBJS) $(COBJS)
	$(FL) $(FLOPTS) -o $@ $(^F) $(FLLIBOPTS)

install: $(TARGET)
	cp $(TARGET) $(BINDIR)

.PHONY: clean
depend: $(FRSC)
	makedepf90 $(FSRC) > depend

%.mod %.o : %.f90
	$(FC) $(FCOPTS) $(FCINCOPTS) -c $<
# Include the dependencies file generated by makedepf90
include depend

clean:
	rm -f $(notdir $(FOBJS) $(COBJS)) $(TARGET) *.mod *~ depend *.orig *.backup *.bak

.PHONY: cleandoc
cleandoc:
	rm -rf doc/latex doc/html

.PHONY: doc
doc: 
	doxygen doc/input/Doxyfile
	$(MAKE) -C doc/latex