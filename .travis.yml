# uDALES (https://github.com/uDALES/u-dales).
# Copyright (C) 2019 D. Meyer.

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

language: python

addons:
  apt:
    packages:
      - gfortran
      - libopenmpi-dev
      - openmpi-bin
      - libnetcdf-dev
      - libnetcdff-dev
      - graphviz

matrix:
    include:
        - os: linux
          dist: xenial
          sudo: false
          python: 3.7
          env: BUILD_TYPE=Debug
        - os: linux
          dist: xenial
          sudo: false
          python: 3.7
          env: BUILD_TYPE=Release
        - os: osx
          language: generic
          env: BUILD_TYPE=Debug
        - os: osx
          language: generic
          env: BUILD_TYPE=Release

before_install:
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew update                     ; fi
  - if [ "$TRAVIS_OS_NAME" = "osx" ]; then brew install gcc netcdf open-mpi; fi

install:
  - pip install -r tests/requirements.txt

script:
  - python tests/run_tests.py master dmey/comp-tests $BUILD_TYPE

before_deploy:
  - pip3 install graphviz ford mkdocs-material
  - mkdocs build --site-dir build/html
  - ford docs/software/software.md
  - mkdir -p temp/html/0YiO263pFxExSdkMvWfId3qkVUSF4dREFnwM1jQD9y1KvzeAVAWzGykQemUrkJCM
  - mv build/html temp/html/0YiO263pFxExSdkMvWfId3qkVUSF4dREFnwM1jQD9y1KvzeAVAWzGykQemUrkJCM

deploy:
 provider: pages
 skip_cleanup: true
 github_token: $GITHUB_TOKEN
 local_dir: temp/html
 on:
   all_branches: master
   condition: $TRAVIS_OS_NAME = 'linux' && $BUILD_TYPE = 'Release'
