<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="TODO:">
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>readinitfiles &ndash; uDALES</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Font Awesome -->
    <link href="../css/fontawesome.min.css" rel="stylesheet">
    <link href="../css/brands.min.css" rel="stylesheet">
    <link href="../css/regular.min.css" rel="stylesheet">
    <link href="../css/solid.min.css" rel="stylesheet">
    <link href="../css/v4-font-face.min.css" rel="stylesheet">
    <link href="../css/v4-shims.min.css" rel="stylesheet">
    <!-- MathJax -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { equationNumbers: { autoNumber: "AMS" } }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async
            integrity="sha256-DViIOMYdwlM/axqoGDPeUyf0urLoHMN4QACBKyB58Uw=" crossorigin="anonymous"></script>
    <!-- Other scripts and stylesheets -->
    <link href="../css/local.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">uDALES </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                  <li class="nav-item">
                    <a class="nav-link" href="../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/absint.html">Abstract Interfaces</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/types.html">Derived Types</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/namelists.html">Namelists</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../program/dalesurban.html">Program</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>readinitfiles
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                 title=" 5.0% of total for procedures.">676 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/modstartup.f90"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/modstartup.f90.html'>modstartup.f90</a></li>
                <li class="breadcrumb-item"><a href='../module/modstartup.html'>modstartup</a></li>
            <li class="breadcrumb-item active" aria-current="page">readinitfiles</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    // Enable Bootstrap tooltips
    (function () {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    })();
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/readinitfiles.html#src">readinitfiles</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>public  subroutine readinitfiles()  
</h2>
        <div class="card mb-4">
      <h3 class="card-header card-title bg-light">Uses</h3>
      <div class="card-body">
        <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <ul class="list-inline">
                  <li class="list-inline-item"><a href='../module/modmpi.html'>modmpi</a></li>
                  <li class="list-inline-item"><a href='../module/modsubgriddata.html'>modsubgriddata</a></li>
                  <li class="list-inline-item"><a href='../module/modsurfdata.html'>modsurfdata</a></li>
                  <li class="list-inline-item"><a href='../module/modboundary.html'>modboundary</a></li>
                  <li class="list-inline-item"><a href='../module/modfields.html'>modfields</a></li>
                  <li class="list-inline-item"><a href='../module/moddriver.html'>moddriver</a></li>
                  <li class="list-inline-item">decomp_2d</li>
                  <li class="list-inline-item"><a href='../module/modthermodynamics.html'>modthermodynamics</a></li>
                  <li class="list-inline-item"><a href='../module/modinletdata.html'>modinletdata</a></li>
                  <li class="list-inline-item"><a href='../module/modinlet.html'>modinlet</a></li>
                  <li class="list-inline-item"><a href='../module/modglobal.html'>modglobal</a></li>
              </ul>
            </li>
            <li class="list-group-item">
              <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Title: proc~~readinitfiles~~UsesGraph Pages: 1 -->
<svg id="procreadinitfilesUsesGraph" width="362pt" height="444pt"
 viewBox="0.00 0.00 362.06 444.27" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~readinitfiles~~UsesGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 440.27)">
<title>proc~~readinitfiles~~UsesGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-440.27 358.06,-440.27 358.06,4 -4,4"/>
<!-- proc~readinitfiles -->
<g id="proc~~readinitfiles~~UsesGraph_node1" class="node">
<title>proc~readinitfiles</title>
<polygon fill="none" stroke="black" points="354.06,-230.27 280.29,-230.27 280.29,-206 354.06,-206 354.06,-230.27"/>
<text text-anchor="middle" x="317.17" y="-214.53" font-family="Helvetica,sans-Serif" font-size="10.50">readinitfiles</text>
</g>
<!-- decomp_2d -->
<g id="proc~~readinitfiles~~UsesGraph_node2" class="node">
<title>decomp_2d</title>
<polygon fill="#337ab7" stroke="#337ab7" points="78.27,-416.27 4.5,-416.27 4.5,-392 78.27,-392 78.27,-416.27"/>
<text text-anchor="middle" x="41.38" y="-400.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">decomp_2d</text>
</g>
<!-- proc~readinitfiles&#45;&gt;decomp_2d -->
<g id="proc~~readinitfiles~~UsesGraph_edge1" class="edge">
<title>proc~readinitfiles&#45;&gt;decomp_2d</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M313.92,-230.77C308.09,-259.6 289.63,-330.42 244.29,-365.13 220.57,-383.29 141.59,-394.38 89.72,-399.88"/>
<polygon fill="#ff0000" stroke="#ff0000" points="89.56,-396.37 79.96,-400.87 90.27,-403.34 89.56,-396.37"/>
</g>
<!-- module~modboundary -->
<g id="proc~~readinitfiles~~UsesGraph_node3" class="node">
<title>module~modboundary</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node3"><a xlink:href="../module/modboundary.html" xlink:title="modboundary">
<polygon fill="#337ab7" stroke="#337ab7" points="224.79,-314.27 138.27,-314.27 138.27,-290 224.79,-290 224.79,-314.27"/>
<text text-anchor="middle" x="181.53" y="-298.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modboundary</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modboundary -->
<g id="proc~~readinitfiles~~UsesGraph_edge2" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modboundary</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M304.85,-230.66C291.57,-244.69 268.29,-267.28 244.29,-281.13 241.49,-282.75 238.54,-284.27 235.51,-285.7"/>
<polygon fill="#ff0000" stroke="#ff0000" points="234.25,-282.43 226.42,-289.56 236.99,-288.87 234.25,-282.43"/>
</g>
<!-- module~moddriver -->
<g id="proc~~readinitfiles~~UsesGraph_node4" class="node">
<title>module~moddriver</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node4"><a xlink:href="../module/moddriver.html" xlink:title="moddriver">
<polygon fill="#337ab7" stroke="#337ab7" points="215.04,-150.27 148.02,-150.27 148.02,-126 215.04,-126 215.04,-150.27"/>
<text text-anchor="middle" x="181.53" y="-134.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">moddriver</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~moddriver -->
<g id="proc~~readinitfiles~~UsesGraph_edge3" class="edge">
<title>proc~readinitfiles&#45;&gt;module~moddriver</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M301.77,-205.63C287.76,-193.89 265.54,-176.34 244.29,-164.13 238.47,-160.79 232.14,-157.64 225.83,-154.76"/>
<polygon fill="#ff0000" stroke="#ff0000" points="227.26,-151.56 216.69,-150.78 224.46,-157.98 227.26,-151.56"/>
</g>
<!-- module~modfields -->
<g id="proc~~readinitfiles~~UsesGraph_node5" class="node">
<title>module~modfields</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node5"><a xlink:href="../module/modfields.html" xlink:title="modfields">
<polygon fill="#337ab7" stroke="#337ab7" points="213.54,-436.27 149.52,-436.27 149.52,-412 213.54,-412 213.54,-436.27"/>
<text text-anchor="middle" x="181.53" y="-420.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modfields</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modfields -->
<g id="proc~~readinitfiles~~UsesGraph_edge4" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modfields</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M314.58,-230.39C309.81,-262.26 292.85,-348.67 244.29,-398.13 238.7,-403.83 231.66,-408.35 224.36,-411.9"/>
<polygon fill="#ff0000" stroke="#ff0000" points="223.21,-408.58 215.38,-415.71 225.95,-415.03 223.21,-408.58"/>
</g>
<!-- module~modglobal -->
<g id="proc~~readinitfiles~~UsesGraph_node6" class="node">
<title>module~modglobal</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node6"><a xlink:href="../module/modglobal.html" xlink:title="modglobal">
<polygon fill="#337ab7" stroke="#337ab7" points="215.79,-272.27 147.27,-272.27 147.27,-248 215.79,-248 215.79,-272.27"/>
<text text-anchor="middle" x="181.53" y="-256.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modglobal</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modglobal -->
<g id="proc~~readinitfiles~~UsesGraph_edge5" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modglobal</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M280.01,-229.5C263.65,-234.64 244.16,-240.77 226.92,-246.18"/>
<polygon fill="#ff0000" stroke="#ff0000" points="225.91,-242.83 217.42,-249.17 228.01,-249.51 225.91,-242.83"/>
</g>
<!-- module~modinlet -->
<g id="proc~~readinitfiles~~UsesGraph_node7" class="node">
<title>module~modinlet</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node7"><a xlink:href="../module/modinlet.html" xlink:title="modinlet">
<polygon fill="#337ab7" stroke="#337ab7" points="210.91,-230.27 152.14,-230.27 152.14,-206 210.91,-206 210.91,-230.27"/>
<text text-anchor="middle" x="181.53" y="-214.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modinlet</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modinlet -->
<g id="proc~~readinitfiles~~UsesGraph_edge6" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modinlet</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M280.01,-218.13C262.25,-218.13 240.81,-218.13 222.56,-218.13"/>
<polygon fill="#ff0000" stroke="#ff0000" points="222.62,-214.64 212.62,-218.14 222.62,-221.64 222.62,-214.64"/>
</g>
<!-- module~modinletdata -->
<g id="proc~~readinitfiles~~UsesGraph_node8" class="node">
<title>module~modinletdata</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node8"><a xlink:href="../module/modinletdata.html" xlink:title="modinletdata">
<polygon fill="#337ab7" stroke="#337ab7" points="82.77,-190.27 0,-190.27 0,-166 82.77,-166 82.77,-190.27"/>
<text text-anchor="middle" x="41.38" y="-174.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modinletdata</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modinletdata -->
<g id="proc~~readinitfiles~~UsesGraph_edge7" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modinletdata</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M279.93,-206.09C268.63,-202.73 256.04,-199.38 244.29,-197.13 193.82,-187.48 135.28,-182.66 94.27,-180.3"/>
<polygon fill="#ff0000" stroke="#ff0000" points="94.61,-176.81 84.44,-179.76 94.23,-183.8 94.61,-176.81"/>
</g>
<!-- module~modmpi -->
<g id="proc~~readinitfiles~~UsesGraph_node9" class="node">
<title>module~modmpi</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node9"><a xlink:href="../module/modmpi.html" xlink:title="modmpi">
<polygon fill="#337ab7" stroke="#337ab7" points="209.41,-356.27 153.64,-356.27 153.64,-332 209.41,-332 209.41,-356.27"/>
<text text-anchor="middle" x="181.53" y="-340.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modmpi</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modmpi -->
<g id="proc~~readinitfiles~~UsesGraph_edge8" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modmpi</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M310.82,-230.76C300.88,-252.69 277.55,-297.9 244.29,-323.13 237.33,-328.42 228.95,-332.43 220.64,-335.44"/>
<polygon fill="#ff0000" stroke="#ff0000" points="219.8,-332.04 211.33,-338.41 221.92,-338.71 219.8,-332.04"/>
</g>
<!-- module~modsubgriddata -->
<g id="proc~~readinitfiles~~UsesGraph_node10" class="node">
<title>module~modsubgriddata</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node10"><a xlink:href="../module/modsubgriddata.html" xlink:title="modsubgriddata">
<polygon fill="#337ab7" stroke="#337ab7" points="231.16,-108.27 131.89,-108.27 131.89,-84 231.16,-84 231.16,-108.27"/>
<text text-anchor="middle" x="181.53" y="-92.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modsubgriddata</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modsubgriddata -->
<g id="proc~~readinitfiles~~UsesGraph_edge9" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modsubgriddata</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M310.52,-205.66C300.3,-184.44 276.74,-141.3 244.29,-117.13 242.93,-116.12 241.51,-115.15 240.06,-114.23"/>
<polygon fill="#ff0000" stroke="#ff0000" points="241.75,-111.17 231.29,-109.49 238.42,-117.32 241.75,-111.17"/>
</g>
<!-- module~modsurfdata -->
<g id="proc~~readinitfiles~~UsesGraph_node11" class="node">
<title>module~modsurfdata</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node11"><a xlink:href="../module/modsurfdata.html" xlink:title="modsurfdata">
<polygon fill="#337ab7" stroke="#337ab7" points="221.41,-66.27 141.64,-66.27 141.64,-42 221.41,-42 221.41,-66.27"/>
<text text-anchor="middle" x="181.53" y="-50.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modsurfdata</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modsurfdata -->
<g id="proc~~readinitfiles~~UsesGraph_edge10" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modsurfdata</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M313.38,-205.84C306.5,-178.38 286.2,-111.63 244.29,-75.13 240.69,-72 236.59,-69.32 232.27,-67.05"/>
<polygon fill="#ff0000" stroke="#ff0000" points="233.83,-63.91 223.27,-63.04 230.98,-70.3 233.83,-63.91"/>
</g>
<!-- module~modthermodynamics -->
<g id="proc~~readinitfiles~~UsesGraph_node12" class="node">
<title>module~modthermodynamics</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node12"><a xlink:href="../module/modthermodynamics.html" xlink:title="modthermodynamics">
<polygon fill="#337ab7" stroke="#337ab7" points="244.29,-24.27 118.77,-24.27 118.77,0 244.29,0 244.29,-24.27"/>
<text text-anchor="middle" x="181.53" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">modthermodynamics</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;module~modthermodynamics -->
<g id="proc~~readinitfiles~~UsesGraph_edge11" class="edge">
<title>proc~readinitfiles&#45;&gt;module~modthermodynamics</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M314.94,-205.82C311.01,-172.98 295.79,-82.48 244.29,-33.13 243.54,-32.42 242.76,-31.72 241.96,-31.05"/>
<polygon fill="#ff0000" stroke="#ff0000" points="244.14,-28.3 233.9,-25.58 240.21,-34.09 244.14,-28.3"/>
</g>
<!-- mpi -->
<g id="proc~~readinitfiles~~UsesGraph_node13" class="node">
<title>mpi</title>
<g id="a_proc~~readinitfiles~~UsesGraph_node13"><a xlink:href="http://www.mpi-forum.org/docs/mpi-3.1/mpi31-report/node410.htm" xlink:title="mpi">
<polygon fill="#337ab7" stroke="#337ab7" points="68.38,-314.27 14.38,-314.27 14.38,-290 68.38,-290 68.38,-314.27"/>
<text text-anchor="middle" x="41.38" y="-298.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi</text>
</a>
</g>
</g>
<!-- module~modboundary&#45;&gt;mpi -->
<g id="proc~~readinitfiles~~UsesGraph_edge12" class="edge">
<title>module~modboundary&#45;&gt;mpi</title>
<path fill="none" stroke="#ff8b00" stroke-dasharray="5,2" d="M137.95,-302.13C119.44,-302.13 97.94,-302.13 80.02,-302.13"/>
<polygon fill="#ff8b00" stroke="#ff8b00" points="80.07,-298.64 70.07,-302.14 80.07,-305.64 80.07,-298.64"/>
</g>
<!-- module~moddriver&#45;&gt;module~modinletdata -->
<g id="proc~~readinitfiles~~UsesGraph_edge13" class="edge">
<title>module~moddriver&#45;&gt;module~modinletdata</title>
<path fill="none" stroke="#e7ff00" stroke-dasharray="5,2" d="M147.79,-147.61C131.74,-152.26 112.02,-157.97 94,-163.19"/>
<polygon fill="#e7ff00" stroke="#e7ff00" points="93.13,-159.8 84.5,-165.94 95.08,-166.52 93.13,-159.8"/>
</g>
<!-- module~modfields&#45;&gt;decomp_2d -->
<g id="proc~~readinitfiles~~UsesGraph_edge14" class="edge">
<title>module~modfields&#45;&gt;decomp_2d</title>
<path fill="none" stroke="#5cff00" stroke-dasharray="5,2" d="M149.18,-419.6C131.68,-417.06 109.52,-413.85 89.92,-411.02"/>
<polygon fill="#5cff00" stroke="#5cff00" points="90.64,-407.58 80.24,-409.62 89.63,-414.51 90.64,-407.58"/>
</g>
<!-- module~modinlet&#45;&gt;module~modinletdata -->
<g id="proc~~readinitfiles~~UsesGraph_edge15" class="edge">
<title>module~modinlet&#45;&gt;module~modinletdata</title>
<path fill="none" stroke="#00ffb9" stroke-dasharray="5,2" d="M151.91,-209.85C135.18,-205 113.57,-198.75 93.97,-193.07"/>
<polygon fill="#00ffb9" stroke="#00ffb9" points="95.05,-189.74 84.48,-190.32 93.11,-196.47 95.05,-189.74"/>
</g>
<!-- module~modinlet&#45;&gt;mpi -->
<g id="proc~~readinitfiles~~UsesGraph_edge16" class="edge">
<title>module~modinlet&#45;&gt;mpi</title>
<path fill="none" stroke="#00ffb9" stroke-dasharray="5,2" d="M151.95,-225.49C141.18,-228.86 129.06,-233.4 118.77,-239.13 98.01,-250.71 77.39,-268.17 62.81,-281.77"/>
<polygon fill="#00ffb9" stroke="#00ffb9" points="60.47,-279.17 55.67,-288.61 65.31,-284.22 60.47,-279.17"/>
</g>
<!-- module~modmpi&#45;&gt;mpi -->
<g id="proc~~readinitfiles~~UsesGraph_edge17" class="edge">
<title>module~modmpi&#45;&gt;mpi</title>
<path fill="none" stroke="#002eff" stroke-dasharray="5,2" d="M153.24,-335.84C132.15,-329.43 102.75,-320.49 79.53,-313.43"/>
<polygon fill="#002eff" stroke="#002eff" points="80.72,-310.13 70.13,-310.57 78.68,-316.83 80.72,-310.13"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#UsesGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="UsesGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="511pt" height="32pt"
 viewBox="0.00 0.00 510.88 32.27" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28.27)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28.27 506.88,-28.27 506.88,4 -4,4"/>
<!-- Module -->
<g id="node1" class="node">
<title>Module</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54,-24.27 0,-24.27 0,0 54,0 54,-24.27"/>
<text text-anchor="middle" x="27" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Module</text>
</g>
<!-- Submodule -->
<g id="node2" class="node">
<title>Submodule</title>
<polygon fill="#5bc0de" stroke="#5bc0de" points="144.13,-24.27 71.87,-24.27 71.87,0 144.13,0 144.13,-24.27"/>
<text text-anchor="middle" x="108" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Submodule</text>
</g>
<!-- Subroutine -->
<g id="node3" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="231.63,-24.27 162.37,-24.27 162.37,0 231.63,0 231.63,-24.27"/>
<text text-anchor="middle" x="197" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node4" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="306.26,-24.27 249.74,-24.27 249.74,0 306.26,0 306.26,-24.27"/>
<text text-anchor="middle" x="278" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Program -->
<g id="node5" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="381.26,-24.27 324.74,-24.27 324.74,0 381.26,0 381.26,-24.27"/>
<text text-anchor="middle" x="353" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="502.88,-24.27 399.12,-24.27 399.12,0 502.88,0 502.88,-24.27"/>
<text text-anchor="middle" x="451" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a submodule to the (sub)module which it is
descended from. Dashed arrows point from a module or program unit to 
modules which it uses.
</p>
 Where possible, edges connecting nodes are
given different colours to make them easier to distinguish in
large graphs.</div>
            </div>
          </div>
        </div>
            </li>
        </ul>
      </div>
    </div>




    <h3>Arguments</h3>
    <em>None</em>
    <br>
    <br>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Calls</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Title: proc~~readinitfiles~~CallsGraph Pages: 1 -->
<svg id="procreadinitfilesCallsGraph" width="603pt" height="1112pt"
 viewBox="0.00 0.00 603.35 1112.27" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~readinitfiles~~CallsGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 1108.27)">
<title>proc~~readinitfiles~~CallsGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-1108.27 599.35,-1108.27 599.35,4 -4,4"/>
<!-- proc~readinitfiles -->
<g id="proc~~readinitfiles~~CallsGraph_node1" class="node">
<title>proc~readinitfiles</title>
<polygon fill="none" stroke="black" points="73.77,-717.27 0,-717.27 0,-693 73.77,-693 73.77,-717.27"/>
<text text-anchor="middle" x="36.88" y="-701.53" font-family="Helvetica,sans-Serif" font-size="10.50">readinitfiles</text>
</g>
<!-- mpi_bcast -->
<g id="proc~~readinitfiles~~CallsGraph_node2" class="node">
<title>mpi_bcast</title>
<polygon fill="#777777" stroke="#777777" points="203.04,-1104.27 137.52,-1104.27 137.52,-1080 203.04,-1080 203.04,-1104.27"/>
<text text-anchor="middle" x="170.28" y="-1088.54" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_bcast</text>
</g>
<!-- proc~readinitfiles&#45;&gt;mpi_bcast -->
<g id="proc~~readinitfiles~~CallsGraph_edge1" class="edge">
<title>proc~readinitfiles&#45;&gt;mpi_bcast</title>
<path fill="none" stroke="#ff0000" d="M38.84,-717.65C43.42,-774.76 64.79,-1010.26 109.77,-1066.13 114.32,-1071.78 120.33,-1076.23 126.8,-1079.73"/>
<polygon fill="#ff0000" stroke="#ff0000" points="125.25,-1082.87 135.8,-1083.85 128.16,-1076.51 125.25,-1082.87"/>
</g>
<!-- proc~avexy_ibm -->
<g id="proc~~readinitfiles~~CallsGraph_node3" class="node">
<title>proc~avexy_ibm</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node3"><a xlink:href="../proc/avexy_ibm.html" xlink:title="avexy_ibm">
<polygon fill="#d9534f" stroke="#d9534f" points="472.83,-1005.27 405.06,-1005.27 405.06,-981 472.83,-981 472.83,-1005.27"/>
<text text-anchor="middle" x="438.94" y="-989.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">avexy_ibm</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~avexy_ibm -->
<g id="proc~~readinitfiles~~CallsGraph_edge2" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~avexy_ibm</title>
<path fill="none" stroke="#ff0000" d="M39.7,-717.63C44.98,-750.19 63.06,-838.92 109.77,-894.13 162.01,-955.89 189.18,-963.36 266.79,-986.13 308.45,-998.36 358.26,-998.92 393.37,-997.14"/>
<polygon fill="#ff0000" stroke="#ff0000" points="393.4,-1000.65 403.17,-996.55 392.98,-993.66 393.4,-1000.65"/>
</g>
<!-- proc~calc_halflev -->
<g id="proc~~readinitfiles~~CallsGraph_node4" class="node">
<title>proc~calc_halflev</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node4"><a xlink:href="../proc/calc_halflev.html" xlink:title="calc_halflev">
<polygon fill="#d9534f" stroke="#d9534f" points="355.18,-822.27 280.66,-822.27 280.66,-798 355.18,-798 355.18,-822.27"/>
<text text-anchor="middle" x="317.92" y="-806.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">calc_halflev</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~calc_halflev -->
<g id="proc~~readinitfiles~~CallsGraph_edge3" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~calc_halflev</title>
<path fill="none" stroke="#ff0000" d="M51.42,-717.67C65.14,-729.72 87.47,-747.62 109.77,-758.13 161.38,-782.47 225.8,-796.34 268.98,-803.53"/>
<polygon fill="#ff0000" stroke="#ff0000" points="268.37,-806.98 278.8,-805.1 269.48,-800.07 268.37,-806.98"/>
</g>
<!-- proc~drivergen -->
<g id="proc~~readinitfiles~~CallsGraph_node5" class="node">
<title>proc~drivergen</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node5"><a xlink:href="../proc/drivergen.html" xlink:title="drivergen">
<polygon fill="#d9534f" stroke="#d9534f" points="201.91,-749.27 138.64,-749.27 138.64,-725 201.91,-725 201.91,-749.27"/>
<text text-anchor="middle" x="170.28" y="-733.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">drivergen</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~drivergen -->
<g id="proc~~readinitfiles~~CallsGraph_edge4" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~drivergen</title>
<path fill="none" stroke="#ff0000" d="M74.14,-713.96C90.71,-718 110.44,-722.81 127.62,-726.99"/>
<polygon fill="#ff0000" stroke="#ff0000" points="126.47,-730.31 137.02,-729.28 128.13,-723.51 126.47,-730.31"/>
</g>
<!-- proc~halos -->
<g id="proc~~readinitfiles~~CallsGraph_node6" class="node">
<title>proc~halos</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node6"><a xlink:href="../proc/halos.html" xlink:title="halos">
<polygon fill="#d9534f" stroke="#d9534f" points="197.28,-654.27 143.28,-654.27 143.28,-630 197.28,-630 197.28,-654.27"/>
<text text-anchor="middle" x="170.28" y="-638.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">halos</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~halos -->
<g id="proc~~readinitfiles~~CallsGraph_edge5" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~halos</title>
<path fill="none" stroke="#ff0000" d="M64.16,-692.54C83.85,-683.09 111.05,-670.06 132.84,-659.61"/>
<polygon fill="#ff0000" stroke="#ff0000" points="134.18,-662.84 141.69,-655.37 131.16,-656.53 134.18,-662.84"/>
</g>
<!-- proc~randomnize -->
<g id="proc~~readinitfiles~~CallsGraph_node7" class="node">
<title>proc~randomnize</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node7"><a xlink:href="../proc/randomnize.html" xlink:title="randomnize">
<polygon fill="#d9534f" stroke="#d9534f" points="207.91,-612.27 132.64,-612.27 132.64,-588 207.91,-588 207.91,-612.27"/>
<text text-anchor="middle" x="170.28" y="-596.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">randomnize</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~randomnize -->
<g id="proc~~readinitfiles~~CallsGraph_edge6" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~randomnize</title>
<path fill="none" stroke="#ff0000" d="M45.4,-692.79C57.05,-674.64 81.12,-640.78 109.77,-621.13 113.48,-618.59 117.52,-616.33 121.7,-614.31"/>
<polygon fill="#ff0000" stroke="#ff0000" points="123.04,-617.55 130.87,-610.41 120.3,-611.11 123.04,-617.55"/>
</g>
<!-- proc~readdriverfile -->
<g id="proc~~readinitfiles~~CallsGraph_node8" class="node">
<title>proc~readdriverfile</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node8"><a xlink:href="../proc/readdriverfile.html" xlink:title="readdriverfile">
<polygon fill="#d9534f" stroke="#d9534f" points="212.04,-570.27 128.52,-570.27 128.52,-546 212.04,-546 212.04,-570.27"/>
<text text-anchor="middle" x="170.28" y="-554.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">readdriverfile</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~readdriverfile -->
<g id="proc~~readinitfiles~~CallsGraph_edge7" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~readdriverfile</title>
<path fill="none" stroke="#ff0000" d="M41.64,-692.83C49.87,-667.83 71.88,-610.78 109.77,-579.13 112.29,-577.03 115.04,-575.13 117.93,-573.41"/>
<polygon fill="#ff0000" stroke="#ff0000" points="119.44,-576.57 126.8,-568.95 116.29,-570.32 119.44,-576.57"/>
</g>
<!-- proc~readdriverfile_chunk -->
<g id="proc~~readinitfiles~~CallsGraph_node9" class="node">
<title>proc~readdriverfile_chunk</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node9"><a xlink:href="../proc/readdriverfile_chunk.html" xlink:title="readdriverfile_chunk">
<polygon fill="#d9534f" stroke="#d9534f" points="230.79,-528.27 109.77,-528.27 109.77,-504 230.79,-504 230.79,-528.27"/>
<text text-anchor="middle" x="170.28" y="-512.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">readdriverfile_chunk</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~readdriverfile_chunk -->
<g id="proc~~readinitfiles~~CallsGraph_edge8" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~readdriverfile_chunk</title>
<path fill="none" stroke="#ff0000" d="M39.73,-692.63C44.94,-661.79 62.54,-581.38 109.77,-537.13 110.54,-536.41 111.34,-535.72 112.15,-535.04"/>
<polygon fill="#ff0000" stroke="#ff0000" points="114.03,-538 120.42,-529.54 110.15,-532.17 114.03,-538"/>
</g>
<!-- proc~readinletfile -->
<g id="proc~~readinitfiles~~CallsGraph_node10" class="node">
<title>proc~readinletfile</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node10"><a xlink:href="../proc/readinletfile.html" xlink:title="readinletfile">
<polygon fill="#d9534f" stroke="#d9534f" points="207.91,-297.27 132.64,-297.27 132.64,-273 207.91,-273 207.91,-297.27"/>
<text text-anchor="middle" x="170.28" y="-281.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">readinletfile</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~readinletfile -->
<g id="proc~~readinitfiles~~CallsGraph_edge9" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~readinletfile</title>
<path fill="none" stroke="#ff0000" d="M41.82,-692.57C60.18,-633.88 137.6,-386.39 161.93,-308.63"/>
<polygon fill="#ff0000" stroke="#ff0000" points="165.27,-309.69 164.91,-299.1 158.58,-307.6 165.27,-309.69"/>
</g>
<!-- proc~readrestartfiles -->
<g id="proc~~readinitfiles~~CallsGraph_node11" class="node">
<title>proc~readrestartfiles</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node11"><a xlink:href="../proc/readrestartfiles.html" xlink:title="readrestartfiles">
<polygon fill="#d9534f" stroke="#d9534f" points="216.16,-108.27 124.39,-108.27 124.39,-84 216.16,-84 216.16,-108.27"/>
<text text-anchor="middle" x="170.28" y="-92.54" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">readrestartfiles</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~readrestartfiles -->
<g id="proc~~readinitfiles~~CallsGraph_edge10" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~readrestartfiles</title>
<path fill="none" stroke="#ff0000" d="M39.09,-692.69C44.35,-640.08 67,-430.95 109.77,-264.13 123.39,-211.01 146.68,-150.92 159.71,-118.97"/>
<polygon fill="#ff0000" stroke="#ff0000" points="162.86,-120.52 163.44,-109.94 156.39,-117.85 162.86,-120.52"/>
</g>
<!-- proc~slabsum -->
<g id="proc~~readinitfiles~~CallsGraph_node12" class="node">
<title>proc~slabsum</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node12"><a xlink:href="../proc/slabsum.html" xlink:title="slabsum">
<polygon fill="#d9534f" stroke="#d9534f" points="466.83,-1055.27 411.06,-1055.27 411.06,-1031 466.83,-1031 466.83,-1055.27"/>
<text text-anchor="middle" x="438.94" y="-1039.54" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">slabsum</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~slabsum -->
<g id="proc~~readinitfiles~~CallsGraph_edge11" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~slabsum</title>
<path fill="none" stroke="#ff0000" d="M37.87,-717.61C38.49,-756.93 45.74,-879.72 109.77,-948.13 186.97,-1030.63 330.98,-1042.95 399.63,-1043.86"/>
<polygon fill="#ff0000" stroke="#ff0000" points="399.23,-1047.36 409.25,-1043.91 399.26,-1040.36 399.23,-1047.36"/>
</g>
<!-- proc~thermodynamics -->
<g id="proc~~readinitfiles~~CallsGraph_node13" class="node">
<title>proc~thermodynamics</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node13"><a xlink:href="../proc/thermodynamics.html" xlink:title="thermodynamics">
<polygon fill="#d9534f" stroke="#d9534f" points="221.04,-885.27 119.52,-885.27 119.52,-861 221.04,-861 221.04,-885.27"/>
<text text-anchor="middle" x="170.28" y="-869.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">thermodynamics</text>
</a>
</g>
</g>
<!-- proc~readinitfiles&#45;&gt;proc~thermodynamics -->
<g id="proc~~readinitfiles~~CallsGraph_edge12" class="edge">
<title>proc~readinitfiles&#45;&gt;proc~thermodynamics</title>
<path fill="none" stroke="#ff0000" d="M43.83,-717.73C54.86,-740.31 80.08,-788.56 109.77,-823.13 119.36,-834.3 131.58,-845.03 142.44,-853.66"/>
<polygon fill="#ff0000" stroke="#ff0000" points="140.29,-856.42 150.35,-859.75 144.56,-850.87 140.29,-856.42"/>
</g>
<!-- mpi_allreduce -->
<g id="proc~~readinitfiles~~CallsGraph_node15" class="node">
<title>mpi_allreduce</title>
<polygon fill="#777777" stroke="#777777" points="595.35,-1030.27 508.83,-1030.27 508.83,-1006 595.35,-1006 595.35,-1030.27"/>
<text text-anchor="middle" x="552.09" y="-1014.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_allreduce</text>
</g>
<!-- proc~avexy_ibm&#45;&gt;mpi_allreduce -->
<g id="proc~~readinitfiles~~CallsGraph_edge13" class="edge">
<title>proc~avexy_ibm&#45;&gt;mpi_allreduce</title>
<path fill="none" stroke="#ff7f00" d="M473.29,-1000.64C480.94,-1002.36 489.26,-1004.23 497.53,-1006.09"/>
<polygon fill="#ff7f00" stroke="#ff7f00" points="496.69,-1009.49 507.21,-1008.27 498.22,-1002.66 496.69,-1009.49"/>
</g>
<!-- proc~writedriverfile -->
<g id="proc~~readinitfiles~~CallsGraph_node20" class="node">
<title>proc~writedriverfile</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node20"><a xlink:href="../proc/writedriverfile.html" xlink:title="writedriverfile">
<polygon fill="#d9534f" stroke="#d9534f" points="360.81,-780.27 275.04,-780.27 275.04,-756 360.81,-756 360.81,-780.27"/>
<text text-anchor="middle" x="317.92" y="-764.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">writedriverfile</text>
</a>
</g>
</g>
<!-- proc~drivergen&#45;&gt;proc~writedriverfile -->
<g id="proc~~readinitfiles~~CallsGraph_edge14" class="edge">
<title>proc~drivergen&#45;&gt;proc~writedriverfile</title>
<path fill="none" stroke="#7fff00" d="M202.17,-743.71C219.99,-747.5 242.9,-752.38 263.56,-756.78"/>
<polygon fill="#7fff00" stroke="#7fff00" points="262.77,-760.19 273.28,-758.84 264.22,-753.34 262.77,-760.19"/>
</g>
<!-- exchange_halo_z -->
<g id="proc~~readinitfiles~~CallsGraph_node14" class="node">
<title>exchange_halo_z</title>
<polygon fill="#777777" stroke="#777777" points="369.06,-402.27 266.79,-402.27 266.79,-378 369.06,-378 369.06,-402.27"/>
<text text-anchor="middle" x="317.92" y="-386.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">exchange_halo_z</text>
</g>
<!-- proc~halos&#45;&gt;exchange_halo_z -->
<g id="proc~~readinitfiles~~CallsGraph_edge15" class="edge">
<title>proc~halos&#45;&gt;exchange_halo_z</title>
<path fill="none" stroke="#00ff00" d="M197.55,-638.95C209.39,-636.16 222.53,-630.93 230.79,-621.13 291.84,-548.75 207.84,-485.24 266.79,-411.13 267.13,-410.71 267.48,-410.29 267.83,-409.89"/>
<polygon fill="#00ff00" stroke="#00ff00" points="270.02,-412.62 275.37,-403.47 265.49,-407.29 270.02,-412.62"/>
</g>
<!-- proc~xm_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node21" class="node">
<title>proc~xm_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node21"><a xlink:href="../proc/xm_periodic.html" xlink:title="xm_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="356.31,-738.27 279.54,-738.27 279.54,-714 356.31,-714 356.31,-738.27"/>
<text text-anchor="middle" x="317.92" y="-722.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xm_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~xm_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge16" class="edge">
<title>proc~halos&#45;&gt;proc~xm_periodic</title>
<path fill="none" stroke="#00ff00" d="M188.28,-654.76C206.93,-668.26 238.04,-689.81 266.79,-705.13 269.14,-706.39 271.59,-707.62 274.08,-708.83"/>
<polygon fill="#00ff00" stroke="#00ff00" points="272.49,-711.95 283.04,-712.93 275.41,-705.59 272.49,-711.95"/>
</g>
<!-- proc~xq_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node22" class="node">
<title>proc~xq_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node22"><a xlink:href="../proc/xq_periodic.html" xlink:title="xq_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="354.43,-696.27 281.41,-696.27 281.41,-672 354.43,-672 354.43,-696.27"/>
<text text-anchor="middle" x="317.92" y="-680.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xq_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~xq_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge17" class="edge">
<title>proc~halos&#45;&gt;proc~xq_periodic</title>
<path fill="none" stroke="#00ff00" d="M197.66,-649.74C217.82,-655.56 246.15,-663.73 270.14,-670.64"/>
<polygon fill="#00ff00" stroke="#00ff00" points="269.12,-673.99 279.7,-673.4 271.06,-667.27 269.12,-673.99"/>
</g>
<!-- proc~xs_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node23" class="node">
<title>proc~xs_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node23"><a xlink:href="../proc/xs_periodic.html" xlink:title="xs_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="353.68,-654.27 282.16,-654.27 282.16,-630 353.68,-630 353.68,-654.27"/>
<text text-anchor="middle" x="317.92" y="-638.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xs_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~xs_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge18" class="edge">
<title>proc~halos&#45;&gt;proc~xs_periodic</title>
<path fill="none" stroke="#00ff00" d="M197.66,-642.13C217.87,-642.13 246.29,-642.13 270.31,-642.13"/>
<polygon fill="#00ff00" stroke="#00ff00" points="270.19,-645.64 280.19,-642.14 270.19,-638.64 270.19,-645.64"/>
</g>
<!-- proc~xt_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node24" class="node">
<title>proc~xt_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node24"><a xlink:href="../proc/xt_periodic.html" xlink:title="xT_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="354.43,-612.27 281.41,-612.27 281.41,-588 354.43,-588 354.43,-612.27"/>
<text text-anchor="middle" x="317.92" y="-596.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">xT_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~xt_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge19" class="edge">
<title>proc~halos&#45;&gt;proc~xt_periodic</title>
<path fill="none" stroke="#00ff00" d="M197.66,-634.53C217.82,-628.71 246.15,-620.54 270.14,-613.63"/>
<polygon fill="#00ff00" stroke="#00ff00" points="271.06,-617 279.7,-610.87 269.12,-610.28 271.06,-617"/>
</g>
<!-- proc~ym_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node26" class="node">
<title>proc~ym_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node26"><a xlink:href="../proc/ym_periodic.html" xlink:title="ym_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="356.31,-570.27 279.54,-570.27 279.54,-546 356.31,-546 356.31,-570.27"/>
<text text-anchor="middle" x="317.92" y="-554.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ym_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~ym_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge20" class="edge">
<title>proc~halos&#45;&gt;proc~ym_periodic</title>
<path fill="none" stroke="#00ff00" d="M197.57,-636.08C208.46,-632.78 220.85,-627.95 230.79,-621.13 251.07,-607.24 246.92,-593.61 266.79,-579.13 268.15,-578.15 269.56,-577.19 271.01,-576.27"/>
<polygon fill="#00ff00" stroke="#00ff00" points="272.64,-579.37 279.7,-571.47 269.25,-573.25 272.64,-579.37"/>
</g>
<!-- proc~yq_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node27" class="node">
<title>proc~yq_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node27"><a xlink:href="../proc/yq_periodic.html" xlink:title="yq_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="354.43,-528.27 281.41,-528.27 281.41,-504 354.43,-504 354.43,-528.27"/>
<text text-anchor="middle" x="317.92" y="-512.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">yq_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~yq_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge21" class="edge">
<title>proc~halos&#45;&gt;proc~yq_periodic</title>
<path fill="none" stroke="#00ff00" d="M197.48,-637.8C208.88,-634.77 221.67,-629.67 230.79,-621.13 260.44,-593.37 237.95,-565.74 266.79,-537.13 268.32,-535.61 269.98,-534.2 271.73,-532.88"/>
<polygon fill="#00ff00" stroke="#00ff00" points="273.15,-536.12 279.8,-527.87 269.46,-530.17 273.15,-536.12"/>
</g>
<!-- proc~ys_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node28" class="node">
<title>proc~ys_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node28"><a xlink:href="../proc/ys_periodic.html" xlink:title="ys_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="353.68,-486.27 282.16,-486.27 282.16,-462 353.68,-462 353.68,-486.27"/>
<text text-anchor="middle" x="317.92" y="-470.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">ys_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~ys_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge22" class="edge">
<title>proc~halos&#45;&gt;proc~ys_periodic</title>
<path fill="none" stroke="#00ff00" d="M197.7,-638.39C209.27,-635.48 222.16,-630.31 230.79,-621.13 270.7,-578.72 228.12,-538.68 266.79,-495.13 268.47,-493.24 270.35,-491.52 272.36,-489.94"/>
<polygon fill="#00ff00" stroke="#00ff00" points="274,-493.05 280.62,-484.77 270.29,-487.11 274,-493.05"/>
</g>
<!-- proc~yt_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_node29" class="node">
<title>proc~yt_periodic</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node29"><a xlink:href="../proc/yt_periodic.html" xlink:title="yT_periodic">
<polygon fill="#d9534f" stroke="#d9534f" points="354.43,-444.27 281.41,-444.27 281.41,-420 354.43,-420 354.43,-444.27"/>
<text text-anchor="middle" x="317.92" y="-428.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">yT_periodic</text>
</a>
</g>
</g>
<!-- proc~halos&#45;&gt;proc~yt_periodic -->
<g id="proc~~readinitfiles~~CallsGraph_edge23" class="edge">
<title>proc~halos&#45;&gt;proc~yt_periodic</title>
<path fill="none" stroke="#00ff00" d="M197.68,-638.73C209.39,-635.89 222.4,-630.68 230.79,-621.13 281.22,-563.79 218.03,-511.9 266.79,-453.13 268.24,-451.39 269.85,-449.79 271.59,-448.32"/>
<polygon fill="#00ff00" stroke="#00ff00" points="273.46,-451.28 279.87,-442.85 269.6,-445.44 273.46,-451.28"/>
</g>
<!-- proc~excjs -->
<g id="proc~~readinitfiles~~CallsGraph_node18" class="node">
<title>proc~excjs</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node18"><a xlink:href="../proc/excjs.html" xlink:title="excjs">
<polygon fill="#d9534f" stroke="#d9534f" points="344.92,-318.27 290.92,-318.27 290.92,-294 344.92,-294 344.92,-318.27"/>
<text text-anchor="middle" x="317.92" y="-302.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">excjs</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~excjs -->
<g id="proc~~readinitfiles~~CallsGraph_edge24" class="edge">
<title>proc~readinletfile&#45;&gt;proc~excjs</title>
<path fill="none" stroke="#0000ff" d="M208.41,-290.49C230.13,-293.62 257.47,-297.56 279.28,-300.71"/>
<polygon fill="#0000ff" stroke="#0000ff" points="278.54,-304.14 288.94,-302.1 279.54,-297.21 278.54,-304.14"/>
</g>
<!-- proc~yinterpolate -->
<g id="proc~~readinitfiles~~CallsGraph_node25" class="node">
<title>proc~yinterpolate</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node25"><a xlink:href="../proc/yinterpolate.html" xlink:title="yinterpolate">
<polygon fill="#d9534f" stroke="#d9534f" points="355.93,-276.27 279.91,-276.27 279.91,-252 355.93,-252 355.93,-276.27"/>
<text text-anchor="middle" x="317.92" y="-260.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">yinterpolate</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~yinterpolate -->
<g id="proc~~readinitfiles~~CallsGraph_edge25" class="edge">
<title>proc~readinletfile&#45;&gt;proc~yinterpolate</title>
<path fill="none" stroke="#0000ff" d="M208.41,-279.78C226.66,-277.15 248.88,-273.95 268.44,-271.13"/>
<polygon fill="#0000ff" stroke="#0000ff" points="268.71,-274.62 278.11,-269.73 267.72,-267.69 268.71,-274.62"/>
</g>
<!-- proc~zinterpolate -->
<g id="proc~~readinitfiles~~CallsGraph_node30" class="node">
<title>proc~zinterpolate</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node30"><a xlink:href="../proc/zinterpolate.html" xlink:title="zinterpolate">
<polygon fill="#d9534f" stroke="#d9534f" points="355.56,-234.27 280.29,-234.27 280.29,-210 355.56,-210 355.56,-234.27"/>
<text text-anchor="middle" x="317.92" y="-218.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolate</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~zinterpolate -->
<g id="proc~~readinitfiles~~CallsGraph_edge26" class="edge">
<title>proc~readinletfile&#45;&gt;proc~zinterpolate</title>
<path fill="none" stroke="#0000ff" d="M199.64,-272.51C218.61,-264.1 244.15,-252.85 266.79,-243.13 269.9,-241.8 273.12,-240.43 276.36,-239.05"/>
<polygon fill="#0000ff" stroke="#0000ff" points="277.42,-242.41 285.27,-235.3 274.7,-235.96 277.42,-242.41"/>
</g>
<!-- proc~zinterpolatet -->
<g id="proc~~readinitfiles~~CallsGraph_node33" class="node">
<title>proc~zinterpolatet</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node33"><a xlink:href="../proc/zinterpolatet.html" xlink:title="zinterpolatet">
<polygon fill="#d9534f" stroke="#d9534f" points="357.43,-192.27 278.41,-192.27 278.41,-168 357.43,-168 357.43,-192.27"/>
<text text-anchor="middle" x="317.92" y="-176.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolatet</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~zinterpolatet -->
<g id="proc~~readinitfiles~~CallsGraph_edge27" class="edge">
<title>proc~readinletfile&#45;&gt;proc~zinterpolatet</title>
<path fill="none" stroke="#0000ff" d="M182.91,-272.6C199.94,-254.81 233.28,-222.1 266.79,-201.13 268.65,-199.97 270.59,-198.85 272.57,-197.76"/>
<polygon fill="#0000ff" stroke="#0000ff" points="273.99,-200.96 281.38,-193.37 270.87,-194.7 273.99,-200.96"/>
</g>
<!-- proc~zinterpolatew -->
<g id="proc~~readinitfiles~~CallsGraph_node35" class="node">
<title>proc~zinterpolatew</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node35"><a xlink:href="../proc/zinterpolatew.html" xlink:title="zinterpolatew">
<polygon fill="#d9534f" stroke="#d9534f" points="359.68,-360.27 276.16,-360.27 276.16,-336 359.68,-336 359.68,-360.27"/>
<text text-anchor="middle" x="317.92" y="-344.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolatew</text>
</a>
</g>
</g>
<!-- proc~readinletfile&#45;&gt;proc~zinterpolatew -->
<g id="proc~~readinitfiles~~CallsGraph_edge28" class="edge">
<title>proc~readinletfile&#45;&gt;proc~zinterpolatew</title>
<path fill="none" stroke="#0000ff" d="M199.64,-297.76C218.61,-306.17 244.15,-317.42 266.79,-327.13 269.9,-328.47 273.12,-329.84 276.36,-331.22"/>
<polygon fill="#0000ff" stroke="#0000ff" points="274.7,-334.31 285.27,-334.97 277.42,-327.86 274.7,-334.31"/>
</g>
<!-- proc~zinterpolate1d -->
<g id="proc~~readinitfiles~~CallsGraph_node31" class="node">
<title>proc~zinterpolate1d</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node31"><a xlink:href="../proc/zinterpolate1d.html" xlink:title="zinterpolate1d">
<polygon fill="#d9534f" stroke="#d9534f" points="362.31,-66.27 273.54,-66.27 273.54,-42 362.31,-42 362.31,-66.27"/>
<text text-anchor="middle" x="317.92" y="-50.54" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolate1d</text>
</a>
</g>
</g>
<!-- proc~readrestartfiles&#45;&gt;proc~zinterpolate1d -->
<g id="proc~~readinitfiles~~CallsGraph_edge29" class="edge">
<title>proc~readrestartfiles&#45;&gt;proc~zinterpolate1d</title>
<path fill="none" stroke="#7f00ff" d="M214.98,-83.53C229.96,-79.21 246.9,-74.33 262.61,-69.8"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="263.16,-73.28 271.8,-67.15 261.22,-66.55 263.16,-73.28"/>
</g>
<!-- proc~zinterpolate2d -->
<g id="proc~~readinitfiles~~CallsGraph_node32" class="node">
<title>proc~zinterpolate2d</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node32"><a xlink:href="../proc/zinterpolate2d.html" xlink:title="zinterpolate2d">
<polygon fill="#d9534f" stroke="#d9534f" points="362.31,-24.27 273.54,-24.27 273.54,0 362.31,0 362.31,-24.27"/>
<text text-anchor="middle" x="317.92" y="-8.54" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolate2d</text>
</a>
</g>
</g>
<!-- proc~readrestartfiles&#45;&gt;proc~zinterpolate2d -->
<g id="proc~~readinitfiles~~CallsGraph_edge30" class="edge">
<title>proc~readrestartfiles&#45;&gt;proc~zinterpolate2d</title>
<path fill="none" stroke="#7f00ff" d="M188.28,-83.51C206.93,-70.01 238.04,-48.46 266.79,-33.14 269.14,-31.88 271.59,-30.65 274.08,-29.44"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="275.41,-32.68 283.04,-25.34 272.49,-26.32 275.41,-32.68"/>
</g>
<!-- proc~zinterpolatet1d -->
<g id="proc~~readinitfiles~~CallsGraph_node34" class="node">
<title>proc~zinterpolatet1d</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node34"><a xlink:href="../proc/zinterpolatet1d.html" xlink:title="zinterpolatet1d">
<polygon fill="#d9534f" stroke="#d9534f" points="364.18,-150.27 271.66,-150.27 271.66,-126 364.18,-126 364.18,-150.27"/>
<text text-anchor="middle" x="317.92" y="-134.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolatet1d</text>
</a>
</g>
</g>
<!-- proc~readrestartfiles&#45;&gt;proc~zinterpolatet1d -->
<g id="proc~~readinitfiles~~CallsGraph_edge31" class="edge">
<title>proc~readrestartfiles&#45;&gt;proc~zinterpolatet1d</title>
<path fill="none" stroke="#7f00ff" d="M214.98,-108.74C229.96,-113.06 246.9,-117.94 262.61,-122.47"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="261.22,-125.72 271.8,-125.12 263.16,-118.99 261.22,-125.72"/>
</g>
<!-- proc~zinterpolatew1d -->
<g id="proc~~readinitfiles~~CallsGraph_node36" class="node">
<title>proc~zinterpolatew1d</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node36"><a xlink:href="../proc/zinterpolatew1d.html" xlink:title="zinterpolatew1d">
<polygon fill="#d9534f" stroke="#d9534f" points="366.43,-108.27 269.41,-108.27 269.41,-84 366.43,-84 366.43,-108.27"/>
<text text-anchor="middle" x="317.92" y="-92.54" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">zinterpolatew1d</text>
</a>
</g>
</g>
<!-- proc~readrestartfiles&#45;&gt;proc~zinterpolatew1d -->
<g id="proc~~readinitfiles~~CallsGraph_edge32" class="edge">
<title>proc~readrestartfiles&#45;&gt;proc~zinterpolatew1d</title>
<path fill="none" stroke="#7f00ff" d="M216.56,-96.14C229.61,-96.14 244.04,-96.14 257.8,-96.14"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="257.63,-99.64 267.63,-96.14 257.63,-92.64 257.63,-99.64"/>
</g>
<!-- proc~slabsum&#45;&gt;mpi_allreduce -->
<g id="proc~~readinitfiles~~CallsGraph_edge33" class="edge">
<title>proc~slabsum&#45;&gt;mpi_allreduce</title>
<path fill="none" stroke="#ff00ff" d="M467.13,-1037.02C476.39,-1034.94 487.08,-1032.53 497.66,-1030.15"/>
<polygon fill="#ff00ff" stroke="#ff00ff" points="498.12,-1033.64 507.11,-1028.03 496.59,-1026.81 498.12,-1033.64"/>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~avexy_ibm -->
<g id="proc~~readinitfiles~~CallsGraph_edge34" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~avexy_ibm</title>
<path fill="none" stroke="#ff007f" d="M181.6,-885.62C197.74,-904.27 230.86,-939.14 266.79,-957.13 306.97,-977.26 357.89,-986.15 393.7,-990.06"/>
<polygon fill="#ff007f" stroke="#ff007f" points="392.97,-993.51 403.26,-991.02 393.66,-986.54 392.97,-993.51"/>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~calc_halflev -->
<g id="proc~~readinitfiles~~CallsGraph_edge35" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~calc_halflev</title>
<path fill="none" stroke="#ff007f" d="M199.64,-860.51C218.61,-852.1 244.15,-840.85 266.79,-831.13 269.9,-829.8 273.12,-828.43 276.36,-827.05"/>
<polygon fill="#ff007f" stroke="#ff007f" points="277.42,-830.41 285.27,-823.3 274.7,-823.96 277.42,-830.41"/>
</g>
<!-- proc~calthv -->
<g id="proc~~readinitfiles~~CallsGraph_node16" class="node">
<title>proc~calthv</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node16"><a xlink:href="../proc/calthv.html" xlink:title="calthv">
<polygon fill="#d9534f" stroke="#d9534f" points="344.92,-948.27 290.92,-948.27 290.92,-924 344.92,-924 344.92,-948.27"/>
<text text-anchor="middle" x="317.92" y="-932.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">calthv</text>
</a>
</g>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~calthv -->
<g id="proc~~readinitfiles~~CallsGraph_edge36" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~calthv</title>
<path fill="none" stroke="#ff007f" d="M199.64,-885.76C218.61,-894.17 244.15,-905.42 266.79,-915.13 271.13,-917 275.69,-918.94 280.22,-920.85"/>
<polygon fill="#ff007f" stroke="#ff007f" points="278.64,-923.98 289.21,-924.63 281.35,-917.53 278.64,-923.98"/>
</g>
<!-- proc~diagfld -->
<g id="proc~~readinitfiles~~CallsGraph_node17" class="node">
<title>proc~diagfld</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node17"><a xlink:href="../proc/diagfld.html" xlink:title="diagfld">
<polygon fill="#d9534f" stroke="#d9534f" points="344.92,-864.27 290.92,-864.27 290.92,-840 344.92,-840 344.92,-864.27"/>
<text text-anchor="middle" x="317.92" y="-848.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">diagfld</text>
</a>
</g>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~diagfld -->
<g id="proc~~readinitfiles~~CallsGraph_edge37" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~diagfld</title>
<path fill="none" stroke="#ff007f" d="M221.4,-865.91C240.35,-863.18 261.57,-860.12 279.19,-857.58"/>
<polygon fill="#ff007f" stroke="#ff007f" points="279.57,-861.06 288.96,-856.17 278.57,-854.13 279.57,-861.06"/>
</g>
<!-- proc~thermo -->
<g id="proc~~readinitfiles~~CallsGraph_node19" class="node">
<title>proc~thermo</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node19"><a xlink:href="../proc/thermo.html" xlink:title="thermo">
<polygon fill="#d9534f" stroke="#d9534f" points="344.92,-906.27 290.92,-906.27 290.92,-882 344.92,-882 344.92,-906.27"/>
<text text-anchor="middle" x="317.92" y="-890.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">thermo</text>
</a>
</g>
</g>
<!-- proc~thermodynamics&#45;&gt;proc~thermo -->
<g id="proc~~readinitfiles~~CallsGraph_edge38" class="edge">
<title>proc~thermodynamics&#45;&gt;proc~thermo</title>
<path fill="none" stroke="#ff007f" d="M221.4,-880.36C240.35,-883.09 261.57,-886.15 279.19,-888.69"/>
<polygon fill="#ff007f" stroke="#ff007f" points="278.57,-892.14 288.96,-890.1 279.57,-885.21 278.57,-892.14"/>
</g>
<!-- proc~diagfld&#45;&gt;proc~avexy_ibm -->
<g id="proc~~readinitfiles~~CallsGraph_edge39" class="edge">
<title>proc~diagfld&#45;&gt;proc~avexy_ibm</title>
<path fill="none" stroke="#ffc700" d="M345.24,-859.46C353.52,-862.69 362.27,-867.14 369.06,-873.13 399.49,-900 419.77,-943.69 430.03,-970.28"/>
<polygon fill="#ffc700" stroke="#ffc700" points="426.66,-971.26 433.4,-979.44 433.23,-968.84 426.66,-971.26"/>
</g>
<!-- proc~fromztop -->
<g id="proc~~readinitfiles~~CallsGraph_node40" class="node">
<title>proc~fromztop</title>
<g id="a_proc~~readinitfiles~~CallsGraph_node40"><a xlink:href="../proc/fromztop.html" xlink:title="fromztop">
<polygon fill="#d9534f" stroke="#d9534f" points="468.33,-864.27 409.56,-864.27 409.56,-840 468.33,-840 468.33,-864.27"/>
<text text-anchor="middle" x="438.94" y="-848.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">fromztop</text>
</a>
</g>
</g>
<!-- proc~diagfld&#45;&gt;proc~fromztop -->
<g id="proc~~readinitfiles~~CallsGraph_edge40" class="edge">
<title>proc~diagfld&#45;&gt;proc~fromztop</title>
<path fill="none" stroke="#ffc700" d="M345.34,-852.13C360.7,-852.13 380.37,-852.13 397.62,-852.13"/>
<polygon fill="#ffc700" stroke="#ffc700" points="397.59,-855.64 407.59,-852.14 397.59,-848.64 397.59,-855.64"/>
</g>
<!-- mpi_isend -->
<g id="proc~~readinitfiles~~CallsGraph_node37" class="node">
<title>mpi_isend</title>
<polygon fill="#777777" stroke="#777777" points="471.7,-360.27 406.18,-360.27 406.18,-336 471.7,-336 471.7,-360.27"/>
<text text-anchor="middle" x="438.94" y="-344.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_isend</text>
</g>
<!-- proc~excjs&#45;&gt;mpi_isend -->
<g id="proc~~readinitfiles~~CallsGraph_edge41" class="edge">
<title>proc~excjs&#45;&gt;mpi_isend</title>
<path fill="none" stroke="#f3ff00" d="M345.34,-315.46C360.06,-320.65 378.74,-327.24 395.46,-333.14"/>
<polygon fill="#f3ff00" stroke="#f3ff00" points="394.08,-336.37 404.68,-336.4 396.41,-329.77 394.08,-336.37"/>
</g>
<!-- mpi_recv -->
<g id="proc~~readinitfiles~~CallsGraph_node38" class="node">
<title>mpi_recv</title>
<polygon fill="#777777" stroke="#777777" points="468.7,-318.27 409.18,-318.27 409.18,-294 468.7,-294 468.7,-318.27"/>
<text text-anchor="middle" x="438.94" y="-302.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_recv</text>
</g>
<!-- proc~excjs&#45;&gt;mpi_recv -->
<g id="proc~~readinitfiles~~CallsGraph_edge42" class="edge">
<title>proc~excjs&#45;&gt;mpi_recv</title>
<path fill="none" stroke="#f3ff00" d="M345.34,-306.13C360.7,-306.13 380.37,-306.13 397.62,-306.13"/>
<polygon fill="#f3ff00" stroke="#f3ff00" points="397.59,-309.64 407.59,-306.14 397.59,-302.64 397.59,-309.64"/>
</g>
<!-- mpi_wait -->
<g id="proc~~readinitfiles~~CallsGraph_node39" class="node">
<title>mpi_wait</title>
<polygon fill="#777777" stroke="#777777" points="468.33,-276.27 409.56,-276.27 409.56,-252 468.33,-252 468.33,-276.27"/>
<text text-anchor="middle" x="438.94" y="-260.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mpi_wait</text>
</g>
<!-- proc~excjs&#45;&gt;mpi_wait -->
<g id="proc~~readinitfiles~~CallsGraph_edge43" class="edge">
<title>proc~excjs&#45;&gt;mpi_wait</title>
<path fill="none" stroke="#f3ff00" d="M345.34,-296.81C360.99,-291.29 381.12,-284.19 398.62,-278.01"/>
<polygon fill="#f3ff00" stroke="#f3ff00" points="399.41,-281.44 407.68,-274.82 397.08,-274.84 399.41,-281.44"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CallsGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CallsGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 28.20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.873868 0.873868) rotate(0) translate(4 28.27)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28.27 729.52,-28.27 729.52,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="69.27,-24.27 0,-24.27 0,0 69.27,0 69.27,-24.27"/>
<text text-anchor="middle" x="34.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="143.89,-24.27 87.38,-24.27 87.38,0 143.89,0 143.89,-24.27"/>
<text text-anchor="middle" x="115.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="221.39,-24.27 161.88,-24.27 161.88,0 221.39,0 221.39,-24.27"/>
<text text-anchor="middle" x="191.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="368.27,-24.27 239,-24.27 239,0 368.27,0 368.27,-24.27"/>
<text text-anchor="middle" x="303.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="529.39,-24.27 385.88,-24.27 385.88,0 529.39,0 529.39,-24.27"/>
<text text-anchor="middle" x="457.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="603.89,-24.27 547.38,-24.27 547.38,0 603.89,0 603.89,-24.27"/>
<text text-anchor="middle" x="575.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="725.52,-24.27 621.75,-24.27 621.75,0 725.52,0 725.52,-24.27"/>
<text text-anchor="middle" x="673.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 Where possible, edges connecting nodes are
given different colours to make them easier to distinguish in
large graphs.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Called by</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Title: proc~~readinitfiles~~CalledByGraph Pages: 1 -->
<svg id="procreadinitfilesCalledByGraph" width="202pt" height="32pt"
 viewBox="0.00 0.00 202.04 32.27" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~readinitfiles~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28.27)">
<title>proc~~readinitfiles~~CalledByGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28.27 198.04,-28.27 198.04,4 -4,4"/>
<!-- proc~readinitfiles -->
<g id="proc~~readinitfiles~~CalledByGraph_node1" class="node">
<title>proc~readinitfiles</title>
<polygon fill="none" stroke="black" points="194.04,-24.27 120.27,-24.27 120.27,0 194.04,0 194.04,-24.27"/>
<text text-anchor="middle" x="157.15" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50">readinitfiles</text>
</g>
<!-- program~dalesurban -->
<g id="proc~~readinitfiles~~CalledByGraph_node2" class="node">
<title>program~dalesurban</title>
<g id="a_proc~~readinitfiles~~CalledByGraph_node2"><a xlink:href="../program/dalesurban.html" xlink:title="DALESURBAN">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="84.27,-24.27 0,-24.27 0,0 84.27,0 84.27,-24.27"/>
<text text-anchor="middle" x="42.13" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">DALESURBAN</text>
</a>
</g>
</g>
<!-- program~dalesurban&#45;&gt;proc~readinitfiles -->
<g id="proc~~readinitfiles~~CalledByGraph_edge1" class="edge">
<title>program~dalesurban&#45;&gt;proc~readinitfiles</title>
<path fill="none" stroke="#ff0000" d="M84.58,-12.13C92.37,-12.13 100.57,-12.13 108.53,-12.13"/>
<polygon fill="#ff0000" stroke="#ff0000" points="108.42,-15.64 118.42,-12.14 108.42,-8.64 108.42,-15.64"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CalledByGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CalledByGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 12.2.1 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 28.20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.873868 0.873868) rotate(0) translate(4 28.27)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28.27 729.52,-28.27 729.52,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="69.27,-24.27 0,-24.27 0,0 69.27,0 69.27,-24.27"/>
<text text-anchor="middle" x="34.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="143.89,-24.27 87.38,-24.27 87.38,0 143.89,0 143.89,-24.27"/>
<text text-anchor="middle" x="115.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="221.39,-24.27 161.88,-24.27 161.88,0 221.39,0 221.39,-24.27"/>
<text text-anchor="middle" x="191.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="368.27,-24.27 239,-24.27 239,0 368.27,0 368.27,-24.27"/>
<text text-anchor="middle" x="303.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="529.39,-24.27 385.88,-24.27 385.88,0 529.39,0 529.39,-24.27"/>
<text text-anchor="middle" x="457.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="603.89,-24.27 547.38,-24.27 547.38,0 603.89,0 603.89,-24.27"/>
<text text-anchor="middle" x="575.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="725.52,-24.27 621.75,-24.27 621.75,0 725.52,0 725.52,-24.27"/>
<text text-anchor="middle" x="673.63" y="-8.53" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 Where possible, edges connecting nodes are
given different colours to make them easier to distinguish in
large graphs.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br>


    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="w">   </span><span class="k">subroutine </span><span class="n">readinitfiles</span>
<span class="w">      </span><span class="k">use </span><span class="n">modfields</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">w0</span><span class="p">,</span><span class="w"> </span><span class="n">um</span><span class="p">,</span><span class="w"> </span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="n">wm</span><span class="p">,</span><span class="w"> </span><span class="n">thlm</span><span class="p">,</span><span class="w"> </span><span class="n">thl0</span><span class="p">,</span><span class="w"> </span><span class="n">thl0h</span><span class="p">,</span><span class="w"> </span><span class="n">qtm</span><span class="p">,</span><span class="w"> </span><span class="n">qt0</span><span class="p">,</span><span class="w"> </span><span class="n">qt0h</span><span class="p">,</span><span class="w"> </span><span class="n">uinit</span><span class="p">,</span><span class="w"> </span><span class="n">vinit</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">ql0</span><span class="p">,</span><span class="w"> </span><span class="n">ql0h</span><span class="p">,</span><span class="w"> </span><span class="n">thv0h</span><span class="p">,</span><span class="w"> </span><span class="n">sv0</span><span class="p">,</span><span class="w"> </span><span class="n">svm</span><span class="p">,</span><span class="w"> </span><span class="n">e12m</span><span class="p">,</span><span class="w"> </span><span class="n">e120</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">dudxls</span><span class="p">,</span><span class="w"> </span><span class="n">dudyls</span><span class="p">,</span><span class="w"> </span><span class="n">dvdxls</span><span class="p">,</span><span class="w"> </span><span class="n">dvdyls</span><span class="p">,</span><span class="w"> </span><span class="n">dthldxls</span><span class="p">,</span><span class="w"> </span><span class="n">dthldyls</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">dqtdxls</span><span class="p">,</span><span class="w"> </span><span class="n">dqtdyls</span><span class="p">,</span><span class="w"> </span><span class="n">dqtdtls</span><span class="p">,</span><span class="w"> </span><span class="n">dpdx</span><span class="p">,</span><span class="w"> </span><span class="n">dpdxl</span><span class="p">,</span><span class="w"> </span><span class="n">dpdyl</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">wfls</span><span class="p">,</span><span class="w"> </span><span class="n">whls</span><span class="p">,</span><span class="w"> </span><span class="n">ug</span><span class="p">,</span><span class="w"> </span><span class="n">vg</span><span class="p">,</span><span class="w"> </span><span class="n">pgx</span><span class="p">,</span><span class="w"> </span><span class="n">pgy</span><span class="p">,</span><span class="w"> </span><span class="n">uprof</span><span class="p">,</span><span class="w"> </span><span class="n">vprof</span><span class="p">,</span><span class="w"> </span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">e12prof</span><span class="p">,</span><span class="w"> </span><span class="n">svprof</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">v0av</span><span class="p">,</span><span class="w"> </span><span class="n">u0av</span><span class="p">,</span><span class="w"> </span><span class="n">qt0av</span><span class="p">,</span><span class="w"> </span><span class="n">ql0av</span><span class="p">,</span><span class="w"> </span><span class="n">thl0av</span><span class="p">,</span><span class="w"> </span><span class="n">qt0av</span><span class="p">,</span><span class="w"> </span><span class="n">sv0av</span><span class="p">,</span><span class="w"> </span><span class="n">exnf</span><span class="p">,</span><span class="w"> </span><span class="n">exnh</span><span class="p">,</span><span class="w"> </span><span class="n">presf</span><span class="p">,</span><span class="w"> </span><span class="n">presh</span><span class="p">,</span><span class="w"> </span><span class="n">rhof</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">thlpcar</span><span class="p">,</span><span class="w"> </span><span class="n">uav</span><span class="p">,</span><span class="w"> </span><span class="n">thvh</span><span class="p">,</span><span class="w"> </span><span class="n">thvf</span><span class="p">,</span><span class="w"> </span><span class="n">IIc</span><span class="p">,</span><span class="w"> </span><span class="n">IIcs</span><span class="p">,</span><span class="w"> </span><span class="n">IIu</span><span class="p">,</span><span class="w"> </span><span class="n">IIus</span><span class="p">,</span><span class="w"> </span><span class="n">IIv</span><span class="p">,</span><span class="w"> </span><span class="n">IIvs</span><span class="p">,</span><span class="w"> </span><span class="n">IIw</span><span class="p">,</span><span class="w"> </span><span class="n">IIws</span><span class="p">,</span><span class="w"> </span><span class="n">u0h</span><span class="p">,</span><span class="w"> </span><span class="n">thl0c</span>
<span class="w">            </span><span class="k">use </span><span class="n">modglobal</span><span class="p">,</span><span class="w">         </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">ihc</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">jhc</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">khc</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">dtmax</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">runtime</span><span class="p">,</span><span class="n">timeleft</span><span class="p">,</span><span class="n">timee</span><span class="p">,</span><span class="n">ntimee</span><span class="p">,</span><span class="n">ntrun</span><span class="p">,</span><span class="n">btime</span><span class="p">,</span><span class="n">dt_lim</span><span class="p">,</span><span class="n">nsv</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">zf</span><span class="p">,</span><span class="w"> </span><span class="n">zh</span><span class="p">,</span><span class="w"> </span><span class="n">dzf</span><span class="p">,</span><span class="w"> </span><span class="n">dzh</span><span class="p">,</span><span class="w"> </span><span class="n">rv</span><span class="p">,</span><span class="w"> </span><span class="n">rd</span><span class="p">,</span><span class="w"> </span><span class="n">grav</span><span class="p">,</span><span class="w"> </span><span class="n">cp</span><span class="p">,</span><span class="w"> </span><span class="n">rlv</span><span class="p">,</span><span class="w"> </span><span class="n">pref0</span><span class="p">,</span><span class="w"> </span><span class="n">om23_gs</span><span class="p">,</span><span class="w"> </span><span class="n">jgb</span><span class="p">,</span><span class="w"> </span><span class="n">jge</span><span class="p">,</span><span class="w"> </span><span class="n">Uinf</span><span class="p">,</span><span class="w"> </span><span class="n">Vinf</span><span class="p">,</span><span class="w"> </span><span class="n">dy</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">rslabs</span><span class="p">,</span><span class="w"> </span><span class="n">e12min</span><span class="p">,</span><span class="w"> </span><span class="n">dzh</span><span class="p">,</span><span class="w"> </span><span class="n">dtheta</span><span class="p">,</span><span class="w"> </span><span class="n">dqt</span><span class="p">,</span><span class="w"> </span><span class="n">dsv</span><span class="p">,</span><span class="w"> </span><span class="n">cexpnr</span><span class="p">,</span><span class="w"> </span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="n">lwarmstart</span><span class="p">,</span><span class="w"> </span><span class="n">lstratstart</span><span class="p">,</span><span class="w"> </span><span class="n">trestart</span><span class="p">,</span><span class="w"> </span><span class="n">numol</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">ladaptive</span><span class="p">,</span><span class="w"> </span><span class="n">tnextrestart</span><span class="p">,</span><span class="w"> </span><span class="n">jmax</span><span class="p">,</span><span class="w"> </span><span class="n">imax</span><span class="p">,</span><span class="w"> </span><span class="n">xh</span><span class="p">,</span><span class="w"> </span><span class="n">xf</span><span class="p">,</span><span class="w"> </span><span class="n">linoutflow</span><span class="p">,</span><span class="w"> </span><span class="n">lper2inout</span><span class="p">,</span><span class="w"> </span><span class="n">iinletgen</span><span class="p">,</span><span class="w"> </span><span class="n">lreadminl</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">uflowrate</span><span class="p">,</span><span class="w"> </span><span class="n">vflowrate</span><span class="p">,</span><span class="n">ltempeq</span><span class="p">,</span><span class="w"> </span><span class="n">prandtlmoli</span><span class="p">,</span><span class="w"> </span><span class="n">freestreamav</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">tnextfielddump</span><span class="p">,</span><span class="w"> </span><span class="n">tfielddump</span><span class="p">,</span><span class="w"> </span><span class="n">tsample</span><span class="p">,</span><span class="w"> </span><span class="n">tstatsdump</span><span class="p">,</span><span class="w"> </span><span class="n">startfile</span><span class="p">,</span><span class="w"> </span><span class="n">lprofforc</span><span class="p">,</span><span class="w"> </span><span class="n">lchem</span><span class="p">,</span><span class="w"> </span><span class="n">k1</span><span class="p">,</span><span class="w"> </span><span class="n">JNO2</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">idriver</span><span class="p">,</span><span class="n">dtdriver</span><span class="p">,</span><span class="n">driverstore</span><span class="p">,</span><span class="n">tdriverstart</span><span class="p">,</span><span class="n">tdriverstart_cold</span><span class="p">,</span><span class="n">tdriverdump</span><span class="p">,</span><span class="n">lchunkread</span><span class="p">,</span><span class="n">xlen</span><span class="p">,</span><span class="n">ylen</span><span class="p">,</span><span class="n">itot</span><span class="p">,</span><span class="n">jtot</span><span class="p">,</span><span class="n">ibrank</span><span class="p">,</span><span class="n">ierank</span><span class="p">,</span><span class="n">jbrank</span><span class="p">,</span><span class="n">jerank</span><span class="p">,</span><span class="n">BCxm</span><span class="p">,</span><span class="n">BCym</span><span class="p">,</span><span class="n">lrandomize</span><span class="p">,</span><span class="n">BCxq</span><span class="p">,</span><span class="n">BCxs</span><span class="p">,</span><span class="n">BCxT</span><span class="p">,</span><span class="w"> </span><span class="n">BCyq</span><span class="p">,</span><span class="n">BCys</span><span class="p">,</span><span class="n">BCyT</span><span class="p">,</span><span class="n">BCxm_driver</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">tEB</span><span class="p">,</span><span class="n">tnextEB</span><span class="p">,</span><span class="n">dtEB</span><span class="p">,</span><span class="n">BCxs_custom</span><span class="p">,</span><span class="n">lEB</span><span class="p">,</span><span class="n">lfacTlyrs</span><span class="p">,</span><span class="n">tfac</span><span class="p">,</span><span class="n">tnextfac</span><span class="p">,</span><span class="n">dtfac</span>
<span class="w">      </span><span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">ekm</span><span class="p">,</span><span class="w"> </span><span class="n">ekh</span><span class="p">,</span><span class="w"> </span><span class="n">loneeqn</span>
<span class="w">      </span><span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">wtsurf</span><span class="p">,</span><span class="w"> </span><span class="n">wqsurf</span><span class="p">,</span><span class="w"> </span><span class="n">wsvsurf</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">thls</span><span class="p">,</span><span class="w"> </span><span class="n">thvs</span><span class="p">,</span><span class="w"> </span><span class="n">ps</span><span class="p">,</span><span class="w"> </span><span class="n">qts</span><span class="p">,</span><span class="w"> </span><span class="n">svs</span><span class="p">,</span><span class="w"> </span><span class="n">sv_top</span>
<span class="w">      </span><span class="c">! use modsurface,        only : surface,dthldz</span>
<span class="w">      </span><span class="k">use </span><span class="n">modboundary</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">boundary</span><span class="p">,</span><span class="w"> </span><span class="n">tqaver</span><span class="p">,</span><span class="w"> </span><span class="n">halos</span>
<span class="w">      </span><span class="k">use </span><span class="n">modmpi</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">slabsum</span><span class="p">,</span><span class="w"> </span><span class="n">myid</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">,</span><span class="w"> </span><span class="n">my_real</span><span class="p">,</span><span class="w"> </span><span class="n">avexy_ibm</span><span class="p">,</span><span class="w"> </span><span class="n">myidx</span><span class="p">,</span><span class="w"> </span><span class="n">myidy</span>
<span class="w">      </span><span class="k">use </span><span class="n">modthermodynamics</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">thermodynamics</span><span class="p">,</span><span class="w"> </span><span class="n">calc_halflev</span>
<span class="w">      </span><span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">Uinl</span><span class="p">,</span><span class="w"> </span><span class="n">Urec</span><span class="p">,</span><span class="w"> </span><span class="n">Wrec</span><span class="p">,</span><span class="w"> </span><span class="n">u0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">v0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">w0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span><span class="p">,</span><span class="w"> </span><span class="n">vbulk</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="p">,</span><span class="w"> </span><span class="n">Utav</span><span class="p">,</span><span class="w"> </span><span class="n">Ttav</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">uminletbc</span><span class="p">,</span><span class="w"> </span><span class="n">vminletbc</span><span class="p">,</span><span class="w"> </span><span class="n">wminletbc</span><span class="p">,</span><span class="w"> </span><span class="n">u0inletbcold</span><span class="p">,</span><span class="w"> </span><span class="n">v0inletbcold</span><span class="p">,</span><span class="w"> </span><span class="n">w0inletbcold</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">storeu0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">,</span><span class="w"> </span><span class="n">nfile</span><span class="p">,</span><span class="w"> </span><span class="n">Tinl</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="n">Trec</span><span class="p">,</span><span class="w"> </span><span class="n">tminletbc</span><span class="p">,</span><span class="w"> </span><span class="n">t0inletbcold</span><span class="p">,</span><span class="w"> </span><span class="n">t0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">storet0inletbc</span><span class="p">,</span><span class="w"> </span><span class="n">utaui</span><span class="p">,</span><span class="w"> </span><span class="n">ttaui</span><span class="p">,</span><span class="w"> </span><span class="n">iangle</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">u0driver</span><span class="p">,</span><span class="n">umdriver</span><span class="p">,</span><span class="n">v0driver</span><span class="p">,</span><span class="n">vmdriver</span><span class="p">,</span><span class="n">w0driver</span><span class="p">,</span><span class="n">e120driver</span><span class="p">,</span><span class="n">tdriver</span><span class="p">,</span><span class="n">thl0driver</span><span class="p">,</span><span class="n">qt0driver</span><span class="p">,</span><span class="n">storetdriver</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">storeu0driver</span><span class="p">,</span><span class="n">storeumdriver</span><span class="p">,</span><span class="n">storev0driver</span><span class="p">,</span><span class="n">storew0driver</span><span class="p">,</span><span class="n">storee120driver</span><span class="p">,</span><span class="n">storethl0driver</span><span class="p">,</span><span class="n">storeqt0driver</span><span class="p">,&amp;</span>
<span class="w">         </span><span class="n">nstepreaddriver</span>
<span class="w">      </span><span class="k">use </span><span class="n">modinlet</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="n">readinletfile</span>
<span class="w">      </span><span class="k">use </span><span class="n">moddriver</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="p">:</span><span class="w"> </span><span class="n">readdriverfile</span><span class="p">,</span><span class="n">initdriver</span><span class="p">,</span><span class="n">drivergen</span><span class="p">,</span><span class="n">readdriverfile_chunk</span>
<span class="w">      </span><span class="k">use </span><span class="n">decomp_2d</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">exchange_halo_z</span><span class="p">,</span><span class="w"> </span><span class="n">update_halo</span><span class="p">,</span><span class="w"> </span><span class="n">decomp_main</span>

<span class="w">      </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>

<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">height</span><span class="p">(:),</span><span class="w"> </span><span class="n">th0av</span><span class="p">(:)</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jh</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">thv0</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uaverage</span><span class="w"> </span><span class="c">! volume averaged u-velocity</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vaverage</span><span class="w"> </span><span class="c">! volume averaged v-velocity</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uaverager</span><span class="w"> </span><span class="c">! recycle plane</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uaveragei</span><span class="w"> </span><span class="c">! inlet plane</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">taverager</span><span class="w"> </span><span class="c">! recycle plane</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">taveragei</span><span class="w"> </span><span class="c">! inlet plane</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">waverage</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">uprofrot</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vprofrot</span>
<span class="w">      </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span><span class="w">  </span><span class="kd">::</span><span class="w"> </span><span class="n">u_init</span><span class="p">,</span><span class="w"> </span><span class="n">v_init</span><span class="p">,</span><span class="w"> </span><span class="n">thl_init</span><span class="p">,</span><span class="w"> </span><span class="n">qt_init</span>
<span class="w">      </span><span class="kt">real </span><span class="n">tv</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>

<span class="w">      </span><span class="kt">character</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">      </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">height</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span>
<span class="w">      </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">th0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lstratstart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! Switch</span>

<span class="w">         </span><span class="c">! Read restart files as in lwarmstart</span>
<span class="w">         </span><span class="k">call </span><span class="n">readrestartfiles</span>
<span class="w">         </span><span class="n">um</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>
<span class="w">         </span><span class="n">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v0</span>
<span class="w">         </span><span class="n">wm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w0</span>
<span class="w">         </span><span class="n">thlm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span><span class="w"> </span><span class="c">!do this before or just not?</span>
<span class="w">         </span><span class="n">qtm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt0</span>
<span class="w">         </span><span class="n">svm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sv0</span>
<span class="w">         </span><span class="n">e12m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e120</span>

<span class="w">         </span><span class="c">! Overwrite thlm, thl0, qtm, qt0 from prof.inp.xxx</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">            </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">            </span><span class="c">!write (*, &#39;(a80)&#39;) chmess</span>
<span class="w">            </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                  </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>

<span class="w">            </span><span class="c">! write (*, *) &#39;height    thl     qt      u      v     e12&#39;</span>
<span class="w">            </span><span class="c">! do k = ke, kb, -1</span>
<span class="w">            </span><span class="c">!    write (*, &#39;(f7.1,2f8.1,3f7.1)&#39;) &amp;</span>
<span class="w">            </span><span class="c">!       height(k), &amp;</span>
<span class="w">            </span><span class="c">!       thlprof(k), &amp;</span>
<span class="w">            </span><span class="c">!       qtprof(k), &amp;</span>
<span class="w">            </span><span class="c">!       uprof(k), &amp;</span>
<span class="w">            </span><span class="c">!       vprof(k), &amp;</span>
<span class="w">            </span><span class="c">!       e12prof(k)</span>
<span class="w">            </span><span class="c">!</span>
<span class="w">            </span><span class="c">! end do</span>
<span class="w">         </span><span class="k">end if</span><span class="w"> </span><span class="c">!myid=0</span>

<span class="w">         </span><span class="c">! MPI broadcast thl and qt</span>
<span class="w">         </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">         </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">         </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">thlm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">qtm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">         end do</span>

<span class="w">         </span><span class="c">!ILS13 reintroduced thv !tg3315 this part may wrong, could need to use</span>
<span class="w">         </span><span class="k">call </span><span class="n">calc_halflev</span>
<span class="w">         </span><span class="c">! exnf = (presf/pref0)**(rd/cp)  !exner functions not in restart files</span>
<span class="w">         </span><span class="c">! anymore.. or at least not read</span>
<span class="w">         </span><span class="c">! exnh = (presh/pref0)**(rd/cp)</span>

<span class="w">         </span><span class="c">!   write(*,*) &quot;exnf&quot;,enf</span>
<span class="w">         </span><span class="c">!   write(*,*) &quot;exnh&quot;,exnh</span>
<span class="w">         </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">                  </span><span class="c">!write(*,*) &quot;thl0h&quot;,thl0h(i,j,k)</span>
<span class="w">                  </span><span class="n">thv0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                   </span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">         end do</span>

<span class="k">         do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span>
<span class="w">                  </span><span class="n">thv0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                  </span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">         end do</span>

<span class="k">         </span><span class="n">thvh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">         </span><span class="c">! call slabsum(thvh,kb,ke,thv0h,ib-ih,ie+ih,jb-jh,je+jh,kb-kh,ke+kh,ib,ie,jb,je,kb,ke) ! redefine halflevel thv using calculated thv</span>
<span class="w">         </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0h</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIw</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIws</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">         </span><span class="c">! thvh = thvh/rslabs</span>

<span class="w">         </span><span class="n">thvf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">         </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">         </span><span class="c">! call slabsum(thvf,kb,ke,thv0,ib-ih,ie+ih,jb-jh,je+jh,kb-kh,ke+kh,ib,ie,jb,je,kb,ke)</span>
<span class="w">         </span><span class="c">! thvf = thvf/rslabs</span>

<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="c">!if not lstratstart</span>

<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">lwarmstart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">            </span><span class="c">!********************************************************************</span>

<span class="w">            </span><span class="c">!    1.0 prepare initial fields from files &#39;prof.inp&#39; and &#39;scalar.inp&#39;</span>
<span class="w">            </span><span class="c">!    ----------------------------------------------------------------</span>

<span class="w">            </span><span class="c">!--------------------------------------------------------------------</span>
<span class="w">            </span><span class="c">!    1.1 read fields</span>
<span class="w">            </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">            </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtmax</span><span class="o">/</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">            </span><span class="n">timee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">               </span><span class="c">!write (*, &#39;(a80)&#39;) chmess</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>

<span class="w">               </span><span class="c">! Apply rotation in horizontal</span>
<span class="w">               </span><span class="c">!write (6, *) &#39;iangle = &#39;, iangle</span>

<span class="w">               </span><span class="c">!uprofrot = uprof*cos(iangle) - vprof*sin(iangle)</span>
<span class="w">               </span><span class="c">!vprofrot = vprof*cos(iangle) + uprof*sin(iangle)</span>
<span class="w">               </span><span class="c">!uprof = uprofrot</span>
<span class="w">               </span><span class="c">!vprof = vprofrot</span>

<span class="w">               </span><span class="k">close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>
<span class="w">               </span><span class="c">! write (*, *) &#39;height    thl     qt      u      v     e12&#39;</span>
<span class="w">               </span><span class="c">! do k = ke, kb, -1</span>
<span class="w">               </span><span class="c">!    !write (*, &#39;(f7.1,2f8.1,3f7.1)&#39;) &amp;</span>
<span class="w">               </span><span class="c">!    write (*, *) &amp;</span>
<span class="w">               </span><span class="c">!       height(k), &amp;</span>
<span class="w">               </span><span class="c">!       thlprof(k), &amp;</span>
<span class="w">               </span><span class="c">!       qtprof(k), &amp;</span>
<span class="w">               </span><span class="c">!       uprof(k), &amp;</span>
<span class="w">               </span><span class="c">!       vprof(k), &amp;</span>
<span class="w">               </span><span class="c">!       e12prof(k)</span>
<span class="w">               </span><span class="c">!</span>
<span class="w">               </span><span class="c">! end do</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loneeqn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                 if</span><span class="w"> </span><span class="p">(</span><span class="nb">minval</span><span class="p">(</span><span class="n">e12prof</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e12min</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                   write</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;e12 value is zero (or less) in prof.inp&#39;</span>
<span class="w">                   </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="n">e12min</span><span class="p">)</span>
<span class="w">                   </span><span class="k">end do</span>
<span class="k">                 end if</span>
<span class="k">               end if</span>

<span class="k">            end if</span><span class="w"> </span><span class="c">! end if myid==0</span>
<span class="w">            </span><span class="c">! MPI broadcast numbers reading</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">uprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">vprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">e12prof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">thlm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">qtm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">um</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">vm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">               </span><span class="n">wm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">               </span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="n">e12m</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="c">!        ekm (i,j,k) = 0.0</span>
<span class="w">               </span><span class="c">!        ekh (i,j,k) = 0.0</span>
<span class="w">               </span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span>
<span class="w">               </span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">            end do</span>

<span class="k">            do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jhc</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jhc</span>
<span class="w">                  </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ihc</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ihc</span>
<span class="w">                     </span><span class="n">thl0c</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end do</span>
<span class="k">               end do</span>
<span class="k">            end do</span>

<span class="w">            </span><span class="c">! if (ibrank) then</span>
<span class="w">            </span><span class="c">! do j=jb-1,je+1</span>
<span class="w">            </span><span class="c">!   um(ib,j,kb:ke) = uprof</span>
<span class="w">            </span><span class="c">!   um(ib-1,j,kb:ke) = uprof</span>
<span class="w">            </span><span class="c">! end do</span>
<span class="w">            </span><span class="c">! end if</span>
<span class="w">            </span><span class="c">!</span>
<span class="w">            </span><span class="c">! if (ierank) then</span>
<span class="w">            </span><span class="c">! do j=jb-1,je+1</span>
<span class="w">            </span><span class="c">!   !um(ie,j,kb:ke) = uprof</span>
<span class="w">            </span><span class="c">!   um(ie+1,j,kb:ke) = uprof</span>
<span class="w">            </span><span class="c">! end do</span>
<span class="w">            </span><span class="c">! end if</span>


<span class="w">            </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! also for start up</span>

<span class="w">            </span><span class="c">! ILS13 30.11.17, added, not sure if necessary</span>
<span class="w">            </span><span class="c">! ILS13 30.11.1, commented</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jh</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">jh</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ih</span>
<span class="w">                  </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">            end do</span>

<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">lrandomize</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">              </span><span class="c">!! add random fluctuations</span>
<span class="w">              </span><span class="n">krand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">krand</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">              </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">krand</span>
<span class="w">                </span><span class="k">call </span><span class="n">randomnize</span><span class="p">(</span><span class="n">um</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">randu</span><span class="p">,</span><span class="w"> </span><span class="n">irandom</span><span class="p">,</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">jh</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">              do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">krand</span>
<span class="w">                </span><span class="k">call </span><span class="n">randomnize</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">randu</span><span class="p">,</span><span class="w"> </span><span class="n">irandom</span><span class="p">,</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">jh</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">              do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">krand</span>
<span class="w">                </span><span class="k">call </span><span class="n">randomnize</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">randu</span><span class="p">,</span><span class="w"> </span><span class="n">irandom</span><span class="p">,</span><span class="w"> </span><span class="n">ih</span><span class="p">,</span><span class="w"> </span><span class="n">jh</span><span class="p">)</span>
<span class="w">              </span><span class="k">end do</span>
<span class="k">            end if</span>

<span class="w">            </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">            </span><span class="c">!       do j=jb,je</span>
<span class="w">            </span><span class="c">!       do i=ib+1,ie-1</span>
<span class="w">            </span><span class="c">!         call random_number(ran)</span>
<span class="w">            </span><span class="c">!         ran1 = -1. +2.*ran</span>
<span class="w">            </span><span class="c">!         wm(i,j,k)=wm(i,j,k)+ 0.1*Uinf*ran1</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!</span>
<span class="w">            </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">            </span><span class="c">!       do j=jb,je</span>
<span class="w">            </span><span class="c">!       do i=ib+2,ie-1</span>
<span class="w">            </span><span class="c">!         call random_number(ran)</span>
<span class="w">            </span><span class="c">!         ran1 = -1. +2.*ran</span>
<span class="w">            </span><span class="c">!         um(i,j,k)=um(i,j,k)+ 0.1*Uinf*ran1</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!</span>
<span class="w">            </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">            </span><span class="c">!       do j=jb,je</span>
<span class="w">            </span><span class="c">!       do i=ib+1,ie-1</span>
<span class="w">            </span><span class="c">!         call random_number(ran)</span>
<span class="w">            </span><span class="c">!         ran1 = -1. +2.*ran</span>
<span class="w">            </span><span class="c">!         vm(i,j,k)=vm(i,j,k)+ 0.1*Uinf*ran1</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!       end do</span>

<span class="w">            </span><span class="c">! SO: Manually override fields</span>

<span class="w">            </span><span class="c">! if (((BCxm == 1) .and. (BCym == 1)) .or. ((BCxm == 6) .and. (BCym == 6))) then</span>
<span class="w">            </span><span class="c">!   ! TGV (assumes equidistant x grid)</span>
<span class="w">            </span><span class="c">!   do i = ib-1,ie+1</span>
<span class="w">            </span><span class="c">!     do j = jb-1,je+1</span>
<span class="w">            </span><span class="c">!       do k = kb-1,ke+1</span>
<span class="w">            </span><span class="c">!         um(i,j,k) = 1. * sin(4.*atan(1.) * 2. * (dx*((i-1)+myidx*imax)) / ylen) &amp;</span>
<span class="w">            </span><span class="c">!         * cos(4.*atan(1.) * 2. * (dy*((0.5+(j-1))+myidy*jmax)) / ylen) !&amp;</span>
<span class="w">            </span><span class="c">!         !* cos(4.*atan(1.) * 2. * zf(k) / ylen)</span>
<span class="w">            </span><span class="c">!         vm(i,j,k) = 1. *-cos(4.*atan(1.) * 2. * (dx*((0.5+(i-1))+myidx*imax)) / ylen)  &amp;</span>
<span class="w">            </span><span class="c">!         * sin(4.*atan(1.) * 2. * (dy*((j-1)+myidy*jmax)) / ylen) !&amp;</span>
<span class="w">            </span><span class="c">!         !* cos(4.*atan(1.) * 2. * zf(k) / ylen)</span>
<span class="w">            </span><span class="c">!         wm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       end do</span>
<span class="w">            </span><span class="c">!     end do</span>
<span class="w">            </span><span class="c">!   end do</span>
<span class="w">            </span><span class="c">! end if</span>

<span class="w">            </span><span class="c">! ! For shear case</span>
<span class="w">            </span><span class="c">! um(:,:,ke+1) = um(:,:,ke)</span>
<span class="w">            </span><span class="c">! um(ib-1,:,:) = um(ib,:,:)</span>
<span class="w">            </span><span class="c">! um(ie-1,:,:) = um(ie,:,:)</span>
<span class="w">            </span><span class="c">! um(:,jb-1,:) = um(:,jb,:)</span>
<span class="w">            </span><span class="c">! um(:,je+1,:) = um(:,je,:)</span>

<span class="w">            </span><span class="n">u0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span>
<span class="w">            </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span>
<span class="w">            </span><span class="n">w0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span>

<span class="w">            </span><span class="k">call </span><span class="n">halos</span>

<span class="w">            </span><span class="n">uinit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span>
<span class="w">            </span><span class="n">vinit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span>

<span class="w">            </span><span class="c">! ! zeros</span>
<span class="w">            </span><span class="c">! do i = ib,ie</span>
<span class="w">            </span><span class="c">!   do j = jb,je</span>
<span class="w">            </span><span class="c">!     do k = kb,ke</span>
<span class="w">            </span><span class="c">!       um(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       u0(i,j,k) = um(i,j,k)</span>
<span class="w">            </span><span class="c">!       uinit(i,j,k) = um(i,j,k)</span>
<span class="w">            </span><span class="c">!       vm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       v0(i,j,k) = vm(i,j,k)</span>
<span class="w">            </span><span class="c">!       vinit(i,j,k) = vm(i,j,k)</span>
<span class="w">            </span><span class="c">!       wm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       w0(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!     end do</span>
<span class="w">            </span><span class="c">!   end do</span>
<span class="w">            </span><span class="c">! end do</span>

<span class="w">            </span><span class="c">! ! ones</span>
<span class="w">            </span><span class="c">! do i = ib,ie</span>
<span class="w">            </span><span class="c">!   do j = jb,je</span>
<span class="w">            </span><span class="c">!     do k = kb,ke</span>
<span class="w">            </span><span class="c">!       um(i,j,k) = 1.</span>
<span class="w">            </span><span class="c">!       u0(i,j,k) = um(i,j,k)</span>
<span class="w">            </span><span class="c">!       uinit(i,j,k) = um(i,j,k)</span>
<span class="w">            </span><span class="c">!       vm(i,j,k) = 1.</span>
<span class="w">            </span><span class="c">!       v0(i,j,k) = vm(i,j,k)</span>
<span class="w">            </span><span class="c">!       vinit(i,j,k) = vm(i,j,k)</span>
<span class="w">            </span><span class="c">!       wm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       w0(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!     end do</span>
<span class="w">            </span><span class="c">!   end do</span>
<span class="w">            </span><span class="c">! end do</span>

<span class="w">            </span><span class="c">! do i = ib,ie</span>
<span class="w">            </span><span class="c">!   do j = jb,je</span>
<span class="w">            </span><span class="c">!     do k = kb,ke</span>
<span class="w">            </span><span class="c">!       um(i,j,k) = (i + myidx*imax) * (j + myidy*jmax)</span>
<span class="w">            </span><span class="c">!       u0(i,j,k) = (i + myidx*imax) * (j + myidy*jmax)</span>
<span class="w">            </span><span class="c">!       vm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       v0(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       wm(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!       w0(i,j,k) = 0.</span>
<span class="w">            </span><span class="c">!     end do</span>
<span class="w">            </span><span class="c">!   end do</span>
<span class="w">            </span><span class="c">! end do</span>

<span class="w">            </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="c">! call slabsum(uaverage, kb, ke, um, ib - 1, ie + 1, jb - 1, je + 1, kb - 1, ke + 1, ib, ie, jb, je, kb, ke)</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! averaged u-velocity inflow profile</span>
<span class="w">            </span><span class="c">!write (6, *) &#39;Modstartup: ubulk=&#39;, ubulk</span>
<span class="w">            </span><span class="n">vaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="c">! call slabsum(vaverage, kb, ke, vm, ib - 1, ie + 1, jb - 1, je + 1, kb - 1, ke + 1, ib, ie, jb, je, kb, ke)</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="n">vaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            </span><span class="n">vbulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">vaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! averaged u-velocity inflow profile</span>

<span class="w">            </span><span class="c">! Set average inlet profile to initial inlet profile in case of inletgenerator mode</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iinletgen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">um</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>
<span class="w">               </span><span class="n">Utav</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">Uinl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to um</span>
<span class="w">               </span><span class="n">Urec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to um</span>
<span class="w">               </span><span class="n">Wrec</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to mean w-profile</span>
<span class="w">               </span><span class="n">u0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">vminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">wminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">u0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="n">utaui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span><span class="n">Uinl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)))</span><span class="w"> </span><span class="c">! average streamwise friction at inlet (need for first time step)</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  </span><span class="n">Ttav</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to thlm</span>
<span class="w">                  </span><span class="n">Tinl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to thlm</span>
<span class="w">                  </span><span class="n">Trec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to thlm</span>
<span class="w">                  </span><span class="n">t0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">t0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">tminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ttaui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">Tinl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thls</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">utaui</span><span class="p">)</span><span class="w"> </span><span class="c">! average friction temp. at inlet (need for first time step)</span>
<span class="w">               </span><span class="k">end if</span>

<span class="w">               </span><span class="c">! add random perturbations</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;random=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran</span><span class="p">,</span><span class="w"> </span><span class="n">ran1</span>
<span class="w">               </span><span class="k">end if</span>

<span class="k">               do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">48</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="n">wm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span><span class="o">*</span><span class="n">Uinf</span><span class="o">*</span><span class="n">ran1</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>
<span class="k">               end do</span>

<span class="w">               </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">48</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="n">um</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span><span class="o">*</span><span class="n">Uinf</span><span class="o">*</span><span class="n">ran1</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>
<span class="k">               end do</span>

<span class="w">               </span><span class="c">!       do k=kb+1,ke-1</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">48</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">               </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">ran</span><span class="p">)</span>
<span class="w">                  </span><span class="n">ran1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">1.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">ran</span>
<span class="w">                  </span><span class="n">vm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span><span class="o">*</span><span class="n">Uinf</span><span class="o">*</span><span class="n">ran1</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>
<span class="k">               end do</span>

<span class="k">               </span><span class="n">u0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span>
<span class="w">               </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span>
<span class="w">               </span><span class="n">w0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span>

<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">iinletgen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">               </span><span class="n">nfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nfile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="k">call </span><span class="n">readinletfile</span>
<span class="w">               </span><span class="n">u0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeu0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">uminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeu0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">vminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">wminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="c">! determine bulk velocity</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>

<span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! idriver</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ibrank</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">lchunkread</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                      call </span><span class="n">readdriverfile_chunk</span>
<span class="w">                  </span><span class="k">else</span>
<span class="k">                     call </span><span class="n">readdriverfile</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">                  call </span><span class="n">drivergen</span>
<span class="w">               </span><span class="k">end if</span>

<span class="w">               </span><span class="c">! do k = kb, ke</span>
<span class="w">               </span><span class="c">!    do j = jb-1, je+1</span>
<span class="w">               </span><span class="c">!       do i = ib-1, ie+1</span>
<span class="w">               </span><span class="c">!          u0(i, j, k) = u0driver(j, k)</span>
<span class="w">               </span><span class="c">!          um(i, j, k) = umdriver(j, k)</span>
<span class="w">               </span><span class="c">!          v0(i, j, k) = v0driver(j, k)</span>
<span class="w">               </span><span class="c">!          vm(i, j, k) = vmdriver(j, k)</span>
<span class="w">               </span><span class="c">!       end do</span>
<span class="w">               </span><span class="c">!    end do</span>
<span class="w">               </span><span class="c">! end do</span>

<span class="w">               </span><span class="c">! if(myid==0) then</span>
<span class="w">                 </span><span class="c">! write(*,*) &#39;Driver inlet velocity&#39;</span>
<span class="w">                 </span><span class="c">! do n=1,driverstore</span>
<span class="w">                   </span><span class="c">! write (*,&#39;(f9.2,e20.12)&#39;) storetdriver(n),     storeu0driver(1,32,n)</span>
<span class="w">                 </span><span class="c">! end do</span>
<span class="w">               </span><span class="c">! endif</span>

<span class="w">              </span><span class="c">! call slabsum(uaverage,kb,ke,u0,ib-1,ie+1,jb-1,je+1,kb-1,ke+1,ib,ie,jb,je,kb,ke)</span>
<span class="w">              </span><span class="c">! uaverage = uaverage / ((ie-ib+1)*(jge-jgb+1))  ! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>

<span class="w">              </span><span class="c">! call avexy_ibm(uaverage(kb:ke),u0(ib:ie,jb:je,kb:ke),ib,ie,jb,je,kb,ke,ih,jh,kh,IIu(ib:ie,jb:je,kb:ke),IIus(kb:ke),.false.)</span>
<span class="w">              </span><span class="c">! do k=kb,ke</span>
<span class="w">              </span><span class="c">!   uaverage(k) = uaverage(k)*dzf(k)</span>
<span class="w">              </span><span class="c">! end do</span>
<span class="w">              </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">!volume-averaged u-velocity</span>

<span class="w">              </span><span class="c">! if (myid==0) then</span>
<span class="w">              </span><span class="c">!    write(6,*) &#39;Modstartup: ubulk=&#39;,ubulk</span>
<span class="w">              </span><span class="c">! end if</span>

<span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">               if</span><span class="w"> </span><span class="p">(</span><span class="n">runtime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tdriverstart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! No driver files will be written as runtime &lt; tdriverstart.&#39;</span>
<span class="w">               </span><span class="k">else</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">trestart</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     </span><span class="n">trestart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F15.5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! for driver simulation, trestart gets set as &amp;</span>
<span class="s1">                                           (tdriverstart + (driverstore-1)*dtdriver), ignoring the &amp;</span>
<span class="s1">                                           trestart mentioned in namoptions. Hence, trestart = &#39;</span><span class="p">,(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">runtime</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">tdriverstart</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">runtime</span><span class="o">+</span><span class="mf">1e-10</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! Driver files cannot be written upto &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">driverstore</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; steps. &amp;</span>
<span class="s1">                                    &amp;Consider taking runtime &gt;= (tdriverstart + (driverstore-1)*dtdriver).&#39;</span>
<span class="w">                     </span><span class="k">end if</span>
<span class="k">                  end if</span>
<span class="k">               end if</span>

<span class="k">              call </span><span class="n">drivergen</span>

<span class="w">            </span><span class="k">end if</span>

<span class="w">            </span><span class="c">!---------------------------------------------------------------</span>
<span class="w">            </span><span class="c">!  1.2 randomnize fields</span>
<span class="w">            </span><span class="c">!---------------------------------------------------------------</span>
<span class="w">            </span><span class="c">!     if (iinletgen /= 2 .and. iinletgen /= 1) then</span>
<span class="w">            </span><span class="c">!       write(6,*) &#39;randomnizing temperature!&#39;</span>
<span class="w">            </span><span class="c">!       krand  = min(krand,ke)</span>
<span class="w">            </span><span class="c">!        do k = kb,ke !edited tg3315 krand --&gt; ke</span>
<span class="w">            </span><span class="c">!          call randomnize(thlm,k,randthl,irandom,ih,jh)</span>
<span class="w">            </span><span class="c">!          call randomnize(thl0,k,randthl,irandom,ih,jh)</span>
<span class="w">            </span><span class="c">!        end do</span>
<span class="w">            </span><span class="c">!       end if</span>

<span class="w">            </span><span class="n">svprof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                  </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                     </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end do</span>
<span class="w">                  </span><span class="c">! open (ifinput, file=&#39;scalar.inp.&#39;//cexpnr)</span>
<span class="w">                  </span><span class="c">! write (6, *) &#39;height   sv(1) --------- sv(nsv) &#39;</span>
<span class="w">                  </span><span class="c">! do k = ke, kb, -1</span>
<span class="w">                  </span><span class="c">!    write (6, *) &amp;</span>
<span class="w">                  </span><span class="c">!       height(k), &amp;</span>
<span class="w">                  </span><span class="c">!       (svprof(k, n), n=1, nsv)</span>
<span class="w">                  </span><span class="c">! end do</span>

<span class="w">               </span><span class="k">end if</span>
<span class="k">            end if</span><span class="w"> </span><span class="c">! end if myid==0</span>

<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">svprof</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span><span class="o">*</span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BCxs</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">BCxs_custom</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                     </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                        </span><span class="k">do </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span>
<span class="w">                           </span><span class="n">sv0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">                           </span><span class="n">svm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">                        </span><span class="k">end do</span>
<span class="k">                     end do</span>
<span class="k">                  end do</span>
<span class="k">               end do</span>
<span class="k">            end if</span>

<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">!tg3315 set these variables here for now and repeat for warmstart</span>

<span class="w">              </span><span class="k">allocate</span><span class="p">(</span><span class="n">sv_top</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">))</span>
<span class="w">              </span><span class="n">sv_top</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svprof</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">)</span>

<span class="w">              </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">sv_top</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">              </span><span class="c">!write(*,*) &#39;svprof&#39;, svprof</span>
<span class="w">              </span><span class="c">!write(*,*) &#39;sv_top&#39;, sv_top</span>

<span class="w">            </span><span class="k">end if</span>

<span class="w">            </span><span class="c">!do n = 1,nsv</span>
<span class="w">            </span><span class="c">!  do j = jb - jhc, je + jhc</span>
<span class="w">            </span><span class="c">!    do i = ib - ihc, ie + ihc</span>
<span class="w">            </span><span class="c">!      svm(i, j, ke + 1, n) = svm(i, j, ke)</span>
<span class="w">            </span><span class="c">!      sv0(i, j, kb - 1, n) = sv0(i, j, kb)</span>
<span class="w">            </span><span class="c">!    end do</span>
<span class="w">            </span><span class="c">!  end do</span>
<span class="w">            </span><span class="c">!end do</span>

<span class="w">            </span><span class="c">!-----------------------------------------------------------------</span>
<span class="w">            </span><span class="c">!    2.2 Initialize surface layer</span>
<span class="w">            </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">         </span><span class="c">!ILS13 reintroduced thv !tg3315 this part may wrong, could need to use</span>
<span class="w">         </span><span class="k">call </span><span class="n">calc_halflev</span>
<span class="w">         </span><span class="c">! exnf = (presf/pref0)**(rd/cp)  !exner functions not in restart files</span>
<span class="w">         </span><span class="c">! anymore.. or at least not read</span>
<span class="w">         </span><span class="c">! exnh = (presh/pref0)**(rd/cp)</span>
<span class="w">         </span><span class="c">!</span>
<span class="w">         </span><span class="c">! call boundary ! tg3315 17.10.17 having this in startup was causing issues for running with lmoist ! turned of when pot. temp = temp.</span>
<span class="w">         </span><span class="c">! SO: can&#39;t do this yet because uses u0 and it does not include halo cells</span>
<span class="w">         </span><span class="k">call </span><span class="n">thermodynamics</span><span class="w"> </span><span class="c">! turned off when pot. temp = temp.</span>
<span class="w">         </span><span class="c">!</span>
<span class="w">         </span><span class="c">!    call boundary</span>
<span class="w">         </span><span class="c">!    call thermodynamics ! turned off when pot. temp = temp.</span>

<span class="w">         </span><span class="k">else</span><span class="w"> </span><span class="c">!if lwarmstart</span>
<span class="w">            </span><span class="c">!write (*, *) &quot;doing warmstart&quot;</span>
<span class="w">            </span><span class="k">call </span><span class="n">readrestartfiles</span>

<span class="w">            </span><span class="c">! average initial profiles</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">u_init</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIu</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIus</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">v_init</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIv</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIvs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thl_init</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">qt_init</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">               </span><span class="c">! Read profiles from file (potentially for forcing)</span>
<span class="w">               </span><span class="k">open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">               </span><span class="c">!write (*, &#39;(a80)&#39;) chmess</span>
<span class="w">               </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>

<span class="w">               </span><span class="c">! Write initial profile</span>
<span class="w">               </span><span class="k">open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof_restart.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;# SDBL flow&#39;</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;# z thl qt u v e12&#39;</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(f20.15,5f12.6)&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">thl_init</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">qt_init</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">u_init</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">v_init</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>

<span class="w">               </span><span class="c">! Apply rotation in horizontal</span>
<span class="w">               </span><span class="c">!write (6, *) &#39;iangle = &#39;, iangle</span>

<span class="w">               </span><span class="c">!uprofrot = uprof*cos(iangle) - vprof*sin(iangle)</span>
<span class="w">               </span><span class="c">!vprofrot = vprof*cos(iangle) + uprof*sin(iangle)</span>
<span class="w">               </span><span class="c">!uprof = uprofrot</span>
<span class="w">               </span><span class="c">!vprof = vprofrot</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">loneeqn</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                 if</span><span class="w"> </span><span class="p">(</span><span class="nb">minval</span><span class="p">(</span><span class="n">e12prof</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">e12min</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                   write</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;e12 value is zero (or less) in prof.inp&#39;</span>
<span class="w">                   </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="n">e12min</span><span class="p">)</span>
<span class="w">                   </span><span class="k">end do</span>
<span class="k">                 end if</span>
<span class="k">               end if</span>

<span class="k">            end if</span><span class="w"> </span><span class="c">! end if myid==0</span>
<span class="w">            </span><span class="c">! MPI broadcast numbers reading</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">uprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">vprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">e12prof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">            </span><span class="n">btime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timee</span>
<span class="w">            </span><span class="n">um</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span>
<span class="w">            </span><span class="n">vm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v0</span>
<span class="w">            </span><span class="n">wm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w0</span>
<span class="w">            </span><span class="n">thlm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thl0</span>
<span class="w">            </span><span class="n">qtm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qt0</span>
<span class="w">            </span><span class="n">svm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sv0</span><span class="w"> </span><span class="c">! What if nsv=0?</span>
<span class="w">            </span><span class="n">e12m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">e120</span>
<span class="w">            </span><span class="n">ekm</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span>
<span class="w">            </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="w"> </span><span class="c">!tg3315 added because wttop using ekh in modboundary which is called in startup</span>

<span class="w">            </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ekh</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="c">! also for start up</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">              </span><span class="c">!driverstore = (timeleft - tdriverstart)/dtdriver + 1</span>
<span class="w">              </span><span class="c">!if(myid==0) then</span>
<span class="w">              </span><span class="c">!  write(*,*) &#39;driverstore: &#39;, driverstore</span>
<span class="w">              </span><span class="c">!end if</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timee</span><span class="o">&gt;=</span><span class="n">tdriverstart</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                  </span><span class="n">tdriverstart_cold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tdriverstart</span>
<span class="w">                  </span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timee</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trestart</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     </span><span class="n">trestart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span>
<span class="w">                  </span><span class="k">end if</span>

<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F15.5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Warning! during warmstart of driver simulat ion, tdriverstart &amp;</span>
<span class="s2">                                           &amp;gets overwritten by the time instant of initd restartfile, ignoring the &amp;</span>
<span class="s2">                                           &amp;tdriverstart mentioned in namoptions. Hence, tdriverstart = &quot;</span><span class="p">,</span><span class="n">timee</span>
<span class="w">                     </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F15.5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! for this driver simulation, trestart gets set as &amp;</span>
<span class="s1">                                           (driverstore-1)*dtdriver, ignoring the trestart mentioned &amp;</span>
<span class="s1">                                           in namoptions. Hence, trestart = &#39;</span><span class="p">,(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! Driver files cannot be written upto &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">driverstore</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; steps. &amp;</span>
<span class="s1">                                    &amp;Consider taking runtime &gt;= (driverstore-1)*dtdriver).&#39;</span>
<span class="w">                     </span><span class="k">end if</span>
<span class="k">                  end if</span>

<span class="k">               else</span><span class="w"> </span><span class="c">! if (timee&lt;tdriverstart)</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trestart</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">btime</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     </span><span class="n">trestart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">btime</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;(A,F15.5)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! for this driver simulation, trestart gets set as &amp;</span>
<span class="s1">                                           (tdriverstart + (driverstore-1)*dtdriver - btime), ignoring the &amp;</span>
<span class="s1">                                           trestart mentioned in namoptions. Hence, trestart = &#39;</span><span class="p">,(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">btime</span>
<span class="w">                     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">timee</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">runtime</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">tdriverstart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">driverstore</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtdriver</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning! Driver files cannot be written upto &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">driverstore</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39; steps. &amp;</span>
<span class="s1">                                    &amp;Consider taking runtime + &#39;</span><span class="p">,</span><span class="n">timee</span><span class="p">,</span><span class="s1">&#39; &gt;= (tdriverstart + (driverstore-1)*dtdriver).&#39;</span>
<span class="w">                     </span><span class="k">end if</span>
<span class="k">                  end if</span>
<span class="k">               end if</span>

<span class="k">              call </span><span class="n">drivergen</span>
<span class="w">              </span><span class="n">tdriverdump</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tdriverstart</span>
<span class="w">            </span><span class="k">endif</span>

<span class="w">            </span><span class="c">!ILS13 reintroduced thv</span>
<span class="w">            </span><span class="k">call </span><span class="n">calc_halflev</span>
<span class="w">            </span><span class="c">! exnf = (presf/pref0)**(rd/cp)  !exner functions not in restart files</span>
<span class="w">            </span><span class="c">! anymore.. or at least not read</span>
<span class="w">            </span><span class="c">! exnh = (presh/pref0)**(rd/cp)</span>

<span class="w">            </span><span class="c">!   write(*,*) &quot;exnf&quot;,enf</span>
<span class="w">            </span><span class="c">!   write(*,*) &quot;exnh&quot;,exnh</span>

<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span>
<span class="w">               </span><span class="c">!write(*,*) &quot;thl0h&quot;,thl0h(i,j,k)</span>
<span class="w">               </span><span class="n">thv0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">            end do</span>

<span class="k">            do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">            </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span>
<span class="w">               </span><span class="n">thv0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                               </span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            end do</span>
<span class="k">            end do</span>

<span class="k">            </span><span class="n">thvh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="c">! call slabsum(thvh,kb,ke,thv0h,ib-ih,ie+ih,jb-jh,je+jh,kb-kh,ke+kh,ib,ie,jb,je,kb,ke) ! redefine halflevel thv using calculated thv</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0h</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIw</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIws</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! thvh = thvh/rslabs</span>

<span class="w">            </span><span class="n">thvf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! call slabsum(thvf,kb,ke,thv0,ib-ih,ie+ih,jb-jh,je+jh,kb-kh,ke+kh,ib,ie,jb,je,kb,ke)</span>
<span class="w">            </span><span class="c">! thvf = thvf/rslabs</span>

<span class="w">            </span><span class="c">! Set average inlet profile to initial inlet profile in case of inletgenerator mode</span>
<span class="w">            </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">uaveragei</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">uaverager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">waverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">taveragei</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="n">taverager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iinletgen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaveragei</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverager</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">waverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">w0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="n">uaveragei</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaveragei</span><span class="o">/</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! this gives the j-averaged u-velocity at the inlet</span>
<span class="w">               </span><span class="n">uaverager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverager</span><span class="o">/</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! this gives the j-averaged u-velocity at the recycle plane</span>
<span class="w">               </span><span class="n">waverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged w-velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">taveragei</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">thl0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">taverager</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">thl0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">irecy</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">taveragei</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taveragei</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the j-averaged temperature at the inlet</span>
<span class="w">                  </span><span class="n">taverager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taverager</span><span class="o">/</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! this gives the j-averaged temperature at the recycle plane</span>
<span class="w">               </span><span class="k">end if</span>
<span class="k">               if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">lreadminl</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uaverage(kb)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uaverage(ke)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;waverage(ke)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">waverage</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;waverage(ke-20)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">waverage</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;taveragei(kb)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">taveragei</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;taveragei(ke)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">taveragei</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end if</span>

<span class="k">                  </span><span class="n">Utav</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">                  </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">                     </span><span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span>
<span class="w">                  </span><span class="k">end do</span>

<span class="k">                  </span><span class="n">Uinl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to mean u-profile read from means</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Uinl(kb+10)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">Uinl</span><span class="p">(</span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">                  </span><span class="n">utaui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span><span class="n">Uinl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)))</span><span class="w"> </span><span class="c">! average streamwise friction at inlet (need for first time step)</span>
<span class="w">                  </span><span class="n">Urec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to mean u-profile</span>

<span class="w">                  </span><span class="n">Wrec</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">waverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to mean w-profile</span>
<span class="w">                  </span><span class="n">Wrec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="w"> </span><span class="c">! set the initial time-averaged inlet profile equal to zero</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     </span><span class="n">Ttav</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">                     </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span>
<span class="w">                        </span><span class="n">Ttav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taveragei</span><span class="p">(:)</span>
<span class="w">                     </span><span class="k">end do</span>
<span class="k">                     </span><span class="n">Tinl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taveragei</span>
<span class="w">                     </span><span class="n">Trec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">taveragei</span>
<span class="w">                     </span><span class="n">ttaui</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">Tinl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">thls</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">utaui</span><span class="p">)</span><span class="w"> </span><span class="c">! friction temp. at inlet (need at first time step)</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">               else</span><span class="w"> </span><span class="c">! -&gt; lreadminl -&gt; Uinl, Urec, Wrec already read</span>
<span class="w">                  </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="k">end if</span>

<span class="w">               </span><span class="c">! determine bulk velocity</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>

<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">                  </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">vminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">u0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">v0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">u0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">v0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>

<span class="k">               do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">                  </span><span class="n">wminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">w0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="n">w0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               end do</span>

<span class="k">               if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span>
<span class="w">                     </span><span class="n">tminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                     </span><span class="n">t0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                     </span><span class="n">t0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end do</span>
<span class="k">                  end do</span>
<span class="k">               end if</span>

<span class="k">               write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uminletbc(jb,kb),um(ib,jb,kb)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">),</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">)</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uminletbc(jb+1,kb+10),um(ib,jb+1,kb+10)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">jb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;uminletbc(je,kb+10),um(ib,je,kb+10)=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">uminletbc</span><span class="p">(</span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>

<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">iinletgen</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">               </span><span class="n">nfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nfile</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Loading inletfile&#39;</span>
<span class="w">               </span><span class="k">call </span><span class="n">readinletfile</span>
<span class="w">               </span><span class="n">u0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeu0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">v0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">w0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">uminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storeu0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">vminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storev0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="n">wminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storew0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  </span><span class="n">t0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storet0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">                  </span><span class="n">tminletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">storet0inletbc</span><span class="p">(:,</span><span class="w"> </span><span class="p">:,</span><span class="w"> </span><span class="n">nstepread</span><span class="p">)</span>
<span class="w">               </span><span class="k">end if</span>
<span class="w">               </span><span class="c">! determine bulk velocity</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>

<span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! idriver</span>

<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ibrank</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  if</span><span class="w"> </span><span class="p">(</span><span class="n">lchunkread</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                      call </span><span class="n">readdriverfile_chunk</span>
<span class="w">                  </span><span class="k">else</span>
<span class="k">                     call </span><span class="n">readdriverfile</span>
<span class="w">                  </span><span class="k">end if</span>
<span class="k">                  call </span><span class="n">drivergen</span>
<span class="w">               </span><span class="k">end if</span>

<span class="w">              </span><span class="c">!call slabsum(uaverage,kb,ke,u0,ib-1,ie+1,jb-1,je+1,kb-1,ke+1,ib,ie,jb,je,kb,ke)</span>
<span class="w">              </span><span class="c">!uaverage = uaverage / ((ie-ib+1)*(jge-jgb+1))  ! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">              </span><span class="c">! call avexy_ibm(uaverage(kb:ke),u0(ib:ie,jb:je,kb:ke),ib,ie,jb,je,kb,ke,ih,jh,kh,IIu(ib:ie,jb:je,kb:ke),IIus(kb:ke),.false.)</span>
<span class="w">              </span><span class="c">! do k=kb,ke</span>
<span class="w">              </span><span class="c">!   uaverage(k) = uaverage(k)*dzf(k)</span>
<span class="w">              </span><span class="c">! end do</span>
<span class="w">              </span><span class="c">! ubulk = sum(uaverage(kb:ke))/(zh(ke+1)-zh(kb)) !volume-averaged u-velocity</span>
<span class="w">              </span><span class="c">! if (myid==0) then</span>
<span class="w">              </span><span class="c">!    write(6,*) &#39;Modstartup: ubulk=&#39;,ubulk</span>
<span class="w">              </span><span class="c">! end if</span>

<span class="w">            </span><span class="k">end if</span><span class="w"> </span><span class="c">! iinletgen/idriver</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lper2inout</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! if the restart starts from a periodic simulation to in/outflow, lper2inout should be set to .true.</span>
<span class="w">               </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                  write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;per2inout=.true. -&gt; reading inlet profile from prof.inp.XXX and scalar.inp.XXX&#39;</span>
<span class="w">                  </span><span class="k">open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;prof.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span><span class="w"> </span><span class="c">!  read the inlet profile from prof.inp</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                  </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                  </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>

<span class="w">                  </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                     </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">                  </span><span class="k">end do</span>
<span class="k">                  </span><span class="n">svprof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                     open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                     </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                     </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                     </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                        </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                           </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                           </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                     </span><span class="k">end do</span>
<span class="k">                     open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                     </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;height   sv(1) --------- sv(nsv) &#39;</span>
<span class="w">                     </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">                        </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                           </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                           </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                     </span><span class="k">end do</span>

<span class="k">                  end if</span>
<span class="k">               end if</span><span class="w"> </span><span class="c">! end if myid==0</span>

<span class="w">               </span><span class="c">! MPI broadcast numbers reading</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">uprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">vprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">e12prof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">qtprof</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">               </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">svprof</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span><span class="o">*</span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">linoutflow</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! restart of inoutflow simulation: reproduce inlet boundary condition from restartfile</span>
<span class="w">               </span><span class="k">do </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                  </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                     </span><span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span>
<span class="w">                     </span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">e120</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e120</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="k">do </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span>
<span class="w">                        </span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
<span class="w">                     </span><span class="k">enddo</span>
<span class="k">                  enddo</span>
<span class="k">               enddo</span>
<span class="w">               </span><span class="c">! outlet bulk velocity</span>
<span class="w">               </span><span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">u0</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ib</span><span class="p">,</span><span class="w"> </span><span class="n">ie</span><span class="p">,</span><span class="w"> </span><span class="n">jb</span><span class="p">,</span><span class="w"> </span><span class="n">je</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span><span class="p">)</span>
<span class="w">               </span><span class="n">uaverage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="o">/</span><span class="p">((</span><span class="n">ie</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jge</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">jgb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="c">! this gives the i-j-averaged velocity (only correct for equidistant grid?)</span>
<span class="w">               </span><span class="c">! determine bulk velocity</span>
<span class="w">               </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                  </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">               </span><span class="k">end do</span>
<span class="k">               </span><span class="n">ubulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="w"> </span><span class="c">! volume-averaged u-velocity</span>
<span class="w">               </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Modstartup: ubulk=&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ubulk</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="c">! else per2per... read svprof regardless...</span>

<span class="w">            </span><span class="c">! tg3315 read svprof (but do not use regardless of above...)</span>
<span class="w">              </span><span class="n">svprof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                 if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                    </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                    </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">                    </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">                       </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                          </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                          </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                    </span><span class="k">end do</span>
<span class="k">                    open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;scalar.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">                    </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;height   sv(1) --------- sv(nsv) &#39;</span>
<span class="w">                    </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ke</span><span class="p">,</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span>
<span class="w">                       </span><span class="k">write</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                          </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                          </span><span class="p">(</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">)</span>
<span class="w">                    </span><span class="k">end do</span>

<span class="k">                 end if</span>
<span class="k">              end if</span><span class="w"> </span><span class="c">! end if myid==0</span>

<span class="w">              </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">svprof</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">kh</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">kb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">kh</span><span class="p">))</span><span class="o">*</span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">!tg3315 set these variables here for now and repeat for warmstart</span>

<span class="w">                </span><span class="k">allocate</span><span class="p">(</span><span class="n">sv_top</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">))</span>
<span class="w">                </span><span class="n">sv_top</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">svprof</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">)</span>

<span class="w">                </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">sv_top</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">              </span><span class="k">end if</span>

<span class="k">            end if</span><span class="w"> </span><span class="c">! end if lper2inout</span>

<span class="w">            </span><span class="n">u0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">v0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">thl0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">qt0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">th0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">            </span><span class="n">sv0av</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>

<span class="w">            </span><span class="c">! call slabsum(u0av  ,kb,ke+kh,u0(:,:,kb:ke+kh)  ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">u0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIu</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIus</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! call slabsum(v0av  ,kb,ke+kh,v0(:,:,kb:ke+kh)  ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">v0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIv</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIvs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! call slabsum(thl0av,kb,ke+kh,thl0(:,:,kb:ke+kh),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thl0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="c">! call slabsum(qt0av,kb,ke+kh,qt0(:,:,kb:ke+kh),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">            </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">qt0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">do </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">nsv</span>
<span class="w">               </span><span class="c">! call slabsum(sv0av(kb,n),kb,ke+kh,sv0(ib-ih,jb-jh,kb,n),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<span class="w">               </span><span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">sv0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">            </span><span class="k">end do</span>

<span class="w">            </span><span class="c">! CvH - only do this for fixed timestepping. In adaptive dt comes from restartfile</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">ladaptive</span><span class="p">)</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtmax</span>
<span class="w">            </span><span class="c">!  call boundary</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lEB</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">lfacTlyrs</span><span class="w"> </span><span class="p">.</span><span class="n">eqv</span><span class="p">.</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.))</span><span class="w"> </span><span class="k">then</span>
<span class="k">               if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Warmstarting an EB simulation - consider setting internal facet temperatures&quot;</span>
<span class="w">            </span><span class="k">end if</span>
<span class="k">         end if</span><span class="w"> </span><span class="c">! lwarmstart</span>
<span class="w">      </span><span class="k">end if</span><span class="w"> </span><span class="c">! not lstratstart</span>
<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>
<span class="w">      </span><span class="c">!    2.1 read and initialise fields</span>
<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">myid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         open</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;lscale.inp.&#39;</span><span class="o">//</span><span class="n">cexpnr</span><span class="p">)</span>
<span class="w">         </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">         </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a80)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">chmess</span>
<span class="w">         </span><span class="c">! write (6, *) &#39; height  u_geo  v_geo  pgx  pgy  subs     &#39; &amp;</span>
<span class="w">         </span><span class="c">!    , &#39;   dqtdx      dqtdy        dqtdtls     thl_rad &#39;</span>
<span class="w">         </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">height</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">ug</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">vg</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">pgx</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">pgy</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">wfls</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">dqtdxls</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">dqtdyls</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">dqtdtls</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">               </span><span class="n">thlpcar</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">         </span><span class="k">end do</span>
<span class="k">         close</span><span class="w"> </span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>

<span class="w">         </span><span class="c">! do k = ke, kb, -1</span>
<span class="w">         </span><span class="c">!    write (6, &#39;(3f7.1,5e12.4)&#39;) &amp;</span>
<span class="w">         </span><span class="c">!       height(k), &amp;</span>
<span class="w">         </span><span class="c">!       ug(k), &amp;</span>
<span class="w">         </span><span class="c">!       vg(k), &amp;</span>
<span class="w">         </span><span class="c">!       pgx(k), &amp;</span>
<span class="w">         </span><span class="c">!       pgy(k), &amp;</span>
<span class="w">         </span><span class="c">!       wfls(k), &amp;</span>
<span class="w">         </span><span class="c">!       dqtdxls(k), &amp;</span>
<span class="w">         </span><span class="c">!       dqtdyls(k), &amp;</span>
<span class="w">         </span><span class="c">!       dqtdtls(k), &amp;</span>
<span class="w">         </span><span class="c">!       thlpcar(k)</span>
<span class="w">         </span><span class="c">! end do</span>

<span class="w">      </span><span class="k">end if</span><span class="w"> </span><span class="c">! end myid==0</span>

<span class="w">      </span><span class="c">! MPI broadcast variables read in</span>

<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">ug</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">vg</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">pgx</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">pgy</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">wfls</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">dqtdxls</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">dqtdyls</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">dqtdtls</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">thlpcar</span><span class="p">,</span><span class="w"> </span><span class="n">kmax</span><span class="p">,</span><span class="w"> </span><span class="n">MY_REAL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">comm3d</span><span class="p">,</span><span class="w"> </span><span class="n">mpierr</span><span class="p">)</span>

<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>
<span class="w">      </span><span class="c">!    2.3 make large-scale horizontal pressure gradient</span>
<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">      </span><span class="c">!******include rho if rho = rho(z) /= 1.0 ***********</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lprofforc</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">!tg3315</span>
<span class="w">         </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="n">dpdxl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">pgx</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dpdx</span><span class="w"> </span><span class="c">!-om23_gs*ug(k)-pgx(k)-dpdx</span>
<span class="w">            </span><span class="n">dpdyl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">pgy</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">         </span><span class="k">end do</span>
<span class="k">      else</span>
<span class="k">         do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">            </span><span class="c">!dpdxl(k) =  om23_gs*vg(k)</span>
<span class="w">            </span><span class="c">!dpdyl(k) = -om23_gs*ug(k)</span>
<span class="w">            </span><span class="c">!dpdxl(k) =  -ug(k)</span>
<span class="w">            </span><span class="c">!dpdyl(k) =  -vg(k)</span>
<span class="w">            </span><span class="n">dpdxl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">om23_gs</span><span class="o">*</span><span class="n">vg</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pgx</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dpdx</span><span class="w"> </span><span class="c">!corriolis forcing and pressure gradient</span>
<span class="w">            </span><span class="n">dpdyl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">om23_gs</span><span class="o">*</span><span class="n">ug</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pgy</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<span class="w">         </span><span class="k">end do</span>
<span class="k">      endif</span>

<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>
<span class="w">      </span><span class="c">!    2.4 large-scale subsidence, reintroduced ILS13 05.06.2014</span>
<span class="w">      </span><span class="c">!-----------------------------------------------------------------</span>

<span class="w">      </span><span class="n">whls</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">      </span><span class="k">do </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kb</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ke</span>
<span class="w">         </span><span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">wfls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wfls</span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">      </span><span class="n">whls</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">wfls</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dzf</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">wfls</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wfls</span><span class="p">(</span><span class="n">ke</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span><span class="w"> </span><span class="c">! tg3315 31/07/18 removed a 0.5</span>

<span class="w">      </span><span class="c">!    idtmax = floor(dtmax/tres)</span>
<span class="w">      </span><span class="n">btime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timee</span>
<span class="w">      </span><span class="c">!    timeleft=ceiling(runtime/tres)</span>
<span class="w">      </span><span class="n">timeleft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runtime</span>
<span class="w">      </span><span class="n">dt_lim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timeleft</span>
<span class="w">      </span><span class="c">!    write(6,*) &#39;real(dt)*tres= &#39;,rdt, &#39; dtmax/100= &#39;,dtmax/100</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">lwarmstart</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">lstratstart</span><span class="p">))</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="c">! tg3315 to have cumulative number on restart files</span>
<span class="w">         </span><span class="k">read</span><span class="w"> </span><span class="p">(</span><span class="n">startfile</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">13</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;(i8)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">ntrun</span>
<span class="w">         </span><span class="c">! ntrun = ichar(startfile(6:13))</span>
<span class="w">      </span><span class="k">else</span>
<span class="k">         </span><span class="n">ntrun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="k">end if</span>
<span class="k">      </span><span class="n">ntimee</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">nint</span><span class="p">(</span><span class="n">timee</span><span class="o">/</span><span class="n">dtmax</span><span class="p">)</span>
<span class="w">      </span><span class="n">tnextrestart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">trestart</span>
<span class="w">      </span><span class="n">tnextfielddump</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tfielddump</span>
<span class="w">      </span><span class="n">tEB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span>
<span class="w">      </span><span class="n">tnextEB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dtEB</span>
<span class="w">      </span><span class="n">tfac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span>
<span class="w">      </span><span class="n">tnextfac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">btime</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dtfac</span>
<span class="w">      </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">height</span><span class="p">,</span><span class="w"> </span><span class="n">th0av</span><span class="p">)</span>

<span class="w">      </span><span class="c">!    call boundary</span>

<span class="w">   </span><span class="k">end subroutine </span><span class="n">readinitfiles</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col">
            <p>
              uDALES
 was developed by The uDALES Team<br>              &copy; 2025 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
 on 2025-10-20 12:54 +0000             </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>
  </body>
</html>